<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="RSP">
        <link rel="canonical" href="http://iot-kmutnb.github.com/blogs/training/mqtt_linux_part-4/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>MQTT และการใช้งานสำหรับ Linux (ตอนที่ 4) - IoT Engineering Education</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../../css/extra.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/c.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/cpp.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/arduino.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/typescript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/json.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/vhdl.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/verilog.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/matlab.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/julia.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-966FQ6RN6W"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-966FQ6RN6W');
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">IoT Engineering Education</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#mqtt-linux-4" class="nav-link">MQTT และการใช้งานสำหรับ Linux (ตอนที่ 4)</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#mqtt-broker" class="nav-link">&#9655; การติดตั้ง MQTT Broker</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#mosquitto-clients" class="nav-link">&#9655; การติดตั้ง Mosquitto Clients</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#arduino-mqtt" class="nav-link">&#9655; การเขียนโปรแกรม Arduino สำหรับการเชื่อมต่อด้วยโพรโทคอล MQTT</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_1" class="nav-link">&#9655; กล่าวสรุป</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="mqtt-linux-4">MQTT และการใช้งานสำหรับ Linux (ตอนที่ 4)<a class="headerlink" href="#mqtt-linux-4" title="Permanent link">#</a></h1>
<p>เนื้อหาในตอนที่ 4 นำเสนอการติดตั้ง <strong>Mosquitto Broker</strong> สำหรับ <strong>Linux</strong>
และการเขียนโค้ด <strong>Arduino</strong> สำหรับบอร์ดไมโครคอนโทรเลอร์ <strong>ESP32</strong>
เพื่อเชื่อมต่อกับ <strong>MQTT Broker</strong></p>
<p>&nbsp;</p>
<hr />
<h2 id="mqtt-broker">&#9655; <strong>การติดตั้ง MQTT Broker</strong><a class="headerlink" href="#mqtt-broker" title="Permanent link">#</a></h2>
<p>ถัดไปเป็นขั้นตอนการติดตั้ง <strong>Mosquitto MQTT Broker</strong> สำหรับบอร์ด
<strong>Raspberry Pi</strong> ที่ใช้ระบบปฏิบัติการ <strong>Raspberry Pi OS (64-bit)</strong>
หรือจะทดลองใช้กับ <strong>Ubuntu</strong> ก็ได้</p>
<pre><code class="language-text">$ uname -smv
Linux #1579 SMP PREEMPT Fri Aug 26 11:16:44 BST 2022 aarch64

$ cat /etc/os-release | head -n 1
PRETTY_NAME=&quot;Debian GNU/Linux 11 (bullseye)&quot;
</code></pre>
<p>&nbsp;</p>
<p>1) ทำคำสั่งต่อไปนี้เพื่อติดตั้งแพ็กเกจ <code>mosquitto</code> (เวอร์ชันที่ได้ลองใช้คือ  <strong>v2.0.11-1</strong>)</p>
<pre><code class="language-bash">$ sudo apt update 
$ sudo apt install -y mosquitto
</code></pre>
<p>2) สร้างไฟล์ <code>/etc/mosquitto/mosquitto.conf</code> </p>
<pre><code class="language-bash">$ sudo nano /etc/mosquitto/mosquitto.conf
</code></pre>
<p>และกำหนดรูปแบบการใช้งานดังนี้ </p>
<ul>
<li>การเปิดใช้งานพอร์ต <strong>1883</strong> สำหรับโพรโทคอล <strong>MQTT</strong> แต่ไม่มีการเข้ารหัสสำหรับข้อความ</li>
<li>การเปิดพอร์ต <strong>9001</strong> สำหรับการเชื่อมต่อด้วยโพรโทคอล <strong>WebSockets</strong></li>
<li>การเชื่อมต่อกับโบรกเกอร์ ต้องมีการป้อนชื่อผู้ใช้และรหัสผ่านเท่านั้น เนื่องจากการตั้งค่าให้
<code>allow_anonymous</code> เปลี่ยนจาก <code>true</code> มาเป็น <code>false</code>
และข้อมูลเกี่ยวกับชื่อผู้ใช้และรหัสผ่านจะถูกเก็บไวในไฟล์ <code>/etc/mosquitto/passwd</code></li>
</ul>
<p><strong>File:</strong> <code>/etc/mosquitto/passwd</code></p>
<pre><code class="language-text">pid_file /run/mosquitto/mosquitto.pid

persistence true
persistence_location /var/lib/mosquitto/

log_dest file /var/log/mosquitto/mosquitto.log

include_dir /etc/mosquitto/conf.d

# mqtt
listener 1883
protocol mqtt

# websockets
listener 9001
protocol websockets

allow_anonymous false
password_file /etc/mosquitto/passwd
</code></pre>
<p>บันทึกการแก้ไขลงไฟล์ (<code>Ctrl</code>+<code>o</code> แล้วกด <code>Enter</code>) และจบการทำงาน (<code>Ctrl</code>+<code>x</code>)</p>
<p><img alt="" src="mosquitto_config.png" /></p>
<p>รูป: การแก้ไขไฟล์ <code>/etc/mosquitto/passwd</code> ด้วยโปรแกรม <code>nano</code></p>
<p>3) สร้างบัญชีผู้ใช้ เช่น ชื่อและรหัสผ่านเป็น <code>iot</code> : <code>mqtt</code> โดยจะนำไปเก็บไว้ในไฟล์
<code>/etc/mosquitto/passwd</code> ซึ่งจะถูกสร้างขึ้นใหม่ (<code>-c</code> หมายถึง การสร้างไฟล์ใหม่)
เมื่อทำคำสั่งต่อไปนี้ จะต้องป้อนรหัสผ่านสองครั้งเพื่อเป็นการยืนยัน </p>
<pre><code class="language-bash">sudo mosquitto_passwd -c /etc/mosquitto/passwd iot
</code></pre>
<p>4) เปิดใช้งาน <code>mosquitto</code> และจะทำเริ่มต้นทำงานโดยอัตโนมัติเมื่อมีการรีเซตระบบ</p>
<pre><code class="language-bash">$ sudo systemctl enable mosquitto.service
$ sudo systemctl restart mosquitto
$ sudo systemctl status mosquitto
</code></pre>
<p><img alt="" src="mosquitto_status.png" /></p>
<p>รูป: ตัวอย่างข้อความที่แสดงสถานะการทำงานของ <strong>Mosquitto Server</strong> </p>
<h2 id="mosquitto-clients">&#9655; <strong>การติดตั้ง Mosquitto Clients</strong><a class="headerlink" href="#mosquitto-clients" title="Permanent link">#</a></h2>
<p>ทำคำสั่งเพื่อติดตั้งโปรแกรม <strong>Mosquitto Clients</strong>
เพื่อใช้คำสั่งแบบ <strong>Command Line</strong> เช่น <code>mosquitto_pub</code> และ <code>mosquitto_sub</code></p>
<pre><code class="language-bash">$ sudo apt install mosquitto-clients -y
</code></pre>
<p>ทำคำสั่งเพื่อรอรับข้อความจากโบรกเกอร์ (<strong>localhost</strong>)</p>
<pre><code class="language-bash">$ mosquitto_sub -h localhost -p 1883 \
  -u 'iot' -P 'mqtt' -t 'test/1234/#'
</code></pre>
<p>ในอีกหน้าต่าง  <strong>Terminal</strong> ทำคำสั่งต่อไปนี้ เพื่อลองส่งข้อความไปยัง
<strong>Mosquitto MQTT Broker (localhost)</strong> ลองส่งข้อความหลาย ๆ ครั้ง</p>
<pre><code class="language-bash">$ mosquitto_pub -h localhost -p 1883 \
  -u 'iot' -P 'mqtt' -t 'test/1234/msg' -m 'hello'
</code></pre>
<p>ให้สังเกตว่า จะต้องมีการระบุชื่อผู้ใช้และรหัสผ่านตามที่ได้เคยสร้างไว้เป็นตัวอย่าง คือ <code>iot</code> : <code>mqtt</code>
หากไม่ระบุ หรือไม่ถูกต้อง จะถูกปฏิเสธการเชื่อมต่อจากโบรกเกอร์</p>
<p><img alt="" src="mosquitto_pub_sub.png" /></p>
<p>รูป: สาธิตการสมัครรับข้อความและส่งข้อความไปยังโบรกเกอร์</p>
<p>ถ้าทราบหมายเลขไอซีของ <strong>MQTT Broker</strong> 
ก็สามารถใช้คำสั่ง <code>mosquitto_pub</code> จากเครื่องคอมพิวเตอร์ <strong>Linux</strong> เครื่องอื่น
ในระบบเครือข่ายเดียวกัน ส่งข้อความไปยังโบรกเกอร์ได้  เช่น</p>
<pre><code class="language-bash"># specify the IP address of the MQTT broker
$ export MQTT_SERVER=192.168.98.227

# publish a message to the MQTT broker
$ mosquitto_pub -h $MQTT_SERVER -p 1883 \
  -u 'iot' -P 'mqtt' -t 'test/1234/msg' -m 'hello'
</code></pre>
<hr />
<h2 id="arduino-mqtt">&#9655; <strong>การเขียนโปรแกรม Arduino สำหรับการเชื่อมต่อด้วยโพรโทคอล MQTT</strong><a class="headerlink" href="#arduino-mqtt" title="Permanent link">#</a></h2>
<p>บอร์ดไมโครคอนโทรลเลอร์ที่ได้เลือกมาลองใช้งานคือ <strong>ESP32</strong> 
และสามารถนำมาใช้งานร่วมกับซอฟต์แวร์ <strong>Arduino IDE</strong> (ลองใช้ <strong>v2.0.0</strong>)
หากยังไม่เคยใช้งาน <strong>Arduino IDE</strong> กับ <strong>ESP32</strong> มาก่อน 
จะต้องมีการติดตั้ง <a href="https://docs.espressif.com/projects/arduino-esp32/en/latest/installing.html"><strong>Arduino-ESP32 Core</strong></a>
ให้พร้อมสำหรับการใช้งาน</p>
<p>เปิดใช้งาน <strong>Arduino IDE</strong> ซึ่งจะมีการสร้างไฟล์ <strong>Ardiuno Sketch (.ino)</strong>
ไว้ให้แล้ว ให้บันทึกโดยใช้ชื่อไฟล์ใหม่ เลือกบอร์ดที่ใช้ชิป <strong>ESP32</strong> เช่น <strong>ESP32 Dev Module</strong>
จากนั้นไปยังเมนู <strong>File &gt; Preferences</strong> ในหน้าต่าง <strong>Popup</strong> จะเห็นว่ามีช่องข้อความ ให้เพิ่มรายการ
<strong>Additional boards manager URL</strong> และให้เพิ่มรายการต่อไปนี้ แล้วกดปุ่ม <strong>OK</strong></p>
<p><code>https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json</code></p>
<p>จากนั้นไปที่ <strong>Board Manager</strong> เลือกจากไอคอนทางซ้ายมือ แล้วค้นหารายการ <code>esp32</code>
เพื่อกดติดตั้ง <strong>Arduino-ESP32</strong> (เวอร์ชันล่าสุดที่ได้ลองใช้คือ <strong>v2.0.4</strong>)</p>
<p><img alt="" src="arduino_esp32-1.png" /></p>
<p>รูป: การเพิ่มรายการสำหรับ <strong>Arduino-ESP32 Board Manager</strong></p>
<p><img alt="" src="arduino_esp32-2.png" /></p>
<p>รูป: การติดตั้ง <strong>Arduino-ESP32</strong></p>
<p>&nbsp;</p>
<p>ถัดไปเป็นการติดตั้งไลบรารี <strong>MQTT</strong> (รองรับการใช้งาน <strong>MQTT v3.1.1</strong>) สำหรับ <strong>Arduino</strong> และมีให้เลือกใช้ได้หลายตัวเลือก เช่น</p>
<ul>
<li><a href="https://www.arduino.cc/reference/en/libraries/mqtt/"><strong>MQTT Library by Joel Gaehwiler</strong></a>
(<a href="https://github.com/256dpi/arduino-mqtt"><strong>Github repo</strong></a>)</li>
<li><a href="https://www.arduino.cc/reference/en/libraries/pubsubclient/"><strong>PubSubClient by Nick O'Leary</strong></a>
(<a href="https://github.com/knolleary/pubsubclient"><strong>Github repo</strong></a>)</li>
<li><a href=""><strong>Async MQTT Library for ESP8266/ESP32 by Marvin Roger</strong></a>
 (<a href="https://github.com/marvinroger/async-mqtt-client"><strong>Github repo</strong></a>)</li>
<li><a href="https://www.arduino.cc/reference/en/libraries/asyncmqtt_generic/"><strong>AsyncMQTT_Generic Library by Marvin Roger &amp; Khoi Hoang</strong></a>
 (<a href="https://github.com/khoih-prog/AsyncMQTT_Generic"><strong>Github repo</strong></a>)</li>
</ul>
<p>จากนั้นไปที่ <strong>Library Manager</strong> เลือกจากไอคอนทางซ้ายมือ ค้นหาด้วยคำว่า <code>mqtt</code>
ให้คลิกเลือก "<strong>MQTT Library by Joel Gaehwiler</strong>" (ลองใช้เวอร์ชัน <strong>v2.5.0</strong>) แล้วกดปุ่ม
<strong>Install</strong></p>
<p><img alt="" src="arduino_esp32_mqtt_lib.png" /></p>
<p>รูป: การติดตั้งไลบรารี <strong>MQTT</strong></p>
<p>&nbsp;</p>
<p>ถัดไปเป็นโค้ดตัวอย่าง สาธิตการใช้คำสั่งเพื่อเชื่อมต่อ <strong>ESP32</strong> เข้ากับระบบเครือข่าย <strong>WiFi</strong> 
แล้วจากนั้นจะเชื่อมต่อไปยัง <strong>MQTT Broker</strong> </p>
<ul>
<li>กำหนดให้ <code>MQTT_BROKER</code> เป็นหมายเลขไอพีของบอร์ด <strong>Raspberry Pi</strong>
ที่ทำหน้าที่เป็นโบรกเกอร์ และ <code>MQTT_PORT</code> เป็นหมายเลขพอร์ตของโบรกเกอร์ เช่น <strong>1883</strong></li>
<li><code>WiFiClient net</code> เป็นการสร้างอ็อปเจกต์จากคลาส <code>WiFiClient</code> และอ้างอิงด้วยตัวแปรชื่อ
<code>net</code> ซึ่งจะใช้ในการเชื่อมต่อกับ <strong>WiFi</strong></li>
<li>การเชื่อมต่อกับโบรกเกอร์ จะต้องมีการกำหนดชื่อ <strong>SSID</strong> (<code>WIFI_SSID</code>)
และรหัสป้องกัน (<code>WIFI_PASS</code>) ด้วย </li>
<li><code>MQTTClient client</code> เป็นการสร้างอ็อปเจกต์จากคลาส <code>MQTTClient</code> 
และอ้างอิงด้วยตัวแปรชื่อ <code>client</code> การทำงานของ  <code>MQTTClient</code> จะต้องใช้ <code>WiFiClient</code> ด้วย
เนื่องจากโพรโทคอล <strong>MQTT</strong> ทำงานบนระดับ <strong>TCP/IP</strong> และใช้ <strong>WiFi</strong> ในการสื่อสารผ่านเครือข่าย</li>
<li>คำสั่ง <code>client.connect()</code> เป็นการเริ่มต้นการเชื่อมต่อกับโบรกเกอร์</li>
<li>การเชื่อมต่อกับโบรกเกอร์ จะต้องมีระบุชื่อผู้ใช้และรหัสผ่าน 
(ตั้งค่าโดยใช้ <code>MQTT_USER</code> และ <code>MQTT_PASS</code> ซึ่งได้ประกาศไว้ในไฟล์
<code>arduino_secrets.h</code>) </li>
<li>เมื่อเชื่อมต่อกับเครือข่ายและโบรกเกอร์ได้แล้ว จะมีการสมัครรับข้อความ โดยใช้คำสั่ง
<code>client.subscribe(...)</code> และใช้หัวข้อที่กำหนดไว้โดย
<code>SUB_TOPIC</code> และส่งข้อความในหัวข้อที่กำหนดไว้โดย <code>PUB_TOPIC</code> (ทั้งสองกรณีจะใช้ <strong>QoS=1</strong>)
ดังนั้นเมื่อส่งข้อความออกไปยังโบรกเกอร์ในแต่ละครั้งโดยใช้คำสั่ง  <code>client.publish(...)</code>
ก็จะได้รับข้อความเดียวกันมาจากโบรกเกอร์</li>
<li>คำสั่ง  <code>client.onMessage( onMessageReceived )</code> เป็นการกำหนดให้ใช้ฟังก์ชัน
<code>onMessageReceived(...)</code> เพื่อทำหน้าที่เป็น <strong>Callback Function</strong>
ซึ่งจะถูกเรียกให้ทำงาน เมื่อมีข้อความเข้ามาซึ่งได้รับมาจากโบรกเกอร์</li>
</ul>
<p>&nbsp;</p>
<p><strong>File:</strong> <code>esp32_mqtt_demo-1.ino</code></p>
<pre><code class="language-cpp">#include &lt;WiFi.h&gt;
#include &lt;MQTT.h&gt; // https://github.com/256dpi/arduino-mqtt
#include &quot;arduino_secrets.h&quot;

#define MQTT_BROKER    &quot;192.168.98.227&quot;
#define MQTT_PORT      (1883)

#define CLIENT_ID      &quot;arduino_client&quot;
#define SUB_TOPIC      &quot;test/1234/#&quot;
#define PUB_TOPIC      &quot;test/1234/msg&quot;
#define INTERVAL_MSEC  (5000)

WiFiClient net;        // ESP32 WiFi client 
MQTTClient client;     // MQTT client
uint32_t last_pub_ts_msec = 0; 

void connect() {
  // connect the WiFi network first (if not already connected)
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
  }
  Serial.print( &quot;\n\nConnected: &quot;);
  Serial.println( WiFi.localIP() ); // show the IP address
  // connect/reconnect the MQTT broker
  while ( !client.connect( CLIENT_ID, MQTT_USER, MQTT_PASS) ) {
    delay(1000);
  }
  client.subscribe( SUB_TOPIC, LWMQTT_QOS1 );
}

// This is the callback function for the incoming MQTT message.
void onMessageReceived( String &amp;topic, String &amp;payload ) {
  uint32_t now_msec = millis(); // message reception timestamp
  Serial.printf( &quot;Received: topic='%s', payload='%s', rtt=%lu msec\n&quot;,
         topic.c_str(), payload.c_str(), now_msec-last_pub_ts_msec );
  Serial.flush();
}

void setup() {
  // initialize the Serial port
  Serial.begin( 115200 ); 
  // use WiFi station mode
  WiFi.mode( WIFI_STA );   
  // start the WiFi client
  WiFi.begin( WIFI_SSID, WIFI_PASS ); 
  // initialize the MQTT broker
  client.begin( MQTT_BROKER, MQTT_PORT, net ); 
  // set keepalive to 60 seconds
  client.setKeepAlive( 60 ); 
  // connect with a clean session
  client.setCleanSession( true ); 
  // set the MQTT callback function
  client.onMessage( onMessageReceived ); 
  // connect the WiFi and the MQTT broker
  connect(); 
}

void loop() {
  static uint32_t msg_cnt = 0; // published message count
  static char msg[32]; // message buffer (up to 32 chars)

  if ( !client.connected() ) { 
    // reconnet the WiFi and/or MQTT if disconnected
    connect(); 
  }
  client.loop(); // process the MQTT event (non-blocking call)
  if ( millis() - last_pub_ts_msec &gt;= INTERVAL_MSEC ) {
    sprintf( msg, &quot;hello id=%lu&quot;, ++msg_cnt );
    Serial.printf( &quot;Published: '%s'\n&quot;, msg );
    Serial.flush();
    // update message publishing timestamp
    last_pub_ts_msec = millis(); 
    // publish a message (with QoS=1)
    client.publish( PUB_TOPIC, msg, strlen(msg), false, LWMQTT_QOS1 );
  }
}
</code></pre>
<p>&nbsp;</p>
<p><strong>File:</strong> <code>arduino_secrets.h</code> มีการกำหนดค่าคงที่ดังนี้ เพื่อใช้ในการเชื่อมต่อเครือข่าย
<strong>WiFi</strong> และ <strong>MQTT Broker</strong></p>
<pre><code class="language-cpp">const char WIFI_SSID[] = &quot;YOUR_WIFI_SSID&quot;;
const char WIFI_PASS[] = &quot;YOUR_WIFI_PASSWORD&quot;;
const char MQTT_USER[] = &quot;MQTT_USERNAME&quot;;
const char MQTT_PASS[] = &quot;MQTT_PASSWORD&quot;;
</code></pre>
<p><img alt="" src="arduino_esp32_mqtt_demo.png" /></p>
<p>รูป: ข้อความเอาต์พุตใน <strong>Serial Monitor</strong> ที่ได้จากการทำงานของบอร์ด <strong>ESP32</strong> </p>
<p>&nbsp;</p>
<p>หากต้องการลองใช้งานกับ <strong>test.mosquitto.org</strong> และใช้พอร์ต <strong>1883</strong>  ให้เปลี่ยนการตั้งค่าใหม่ดังนี้</p>
<pre><code class="language-cpp">#define MQTT_BROKER    &quot;test.mosquitto.org&quot;
#define MQTT_PORT      (1883)
</code></pre>
<p>และในไฟล์ <code>arduino_secrets.h</code> ตั้งค่าใหม่สำหรับ <code>MQTT_USER</code> และ <code>MQTT_PASS</code></p>
<pre><code class="language-cpp">const char MQTT_USER[] = &quot;&quot;;
const char MQTT_PASS[] = &quot;&quot;;
</code></pre>
<p>&nbsp;</p>
<hr />
<p>โค้ดตัวอย่างถัดไปสาธิตการใช้ไลบรารีที่มีชื่อว่า <code>PubSubClient</code> (ลองใช้เวอร์ชัน <strong>v2.8</strong>)
เพื่อเชื่อมต่อกับ <strong>test.mosquitto.org</strong>
และลองใช้พอร์ตหมายเลข  <strong>8883</strong> แทน <strong>1883</strong>
ซึ่งจะต้องมีข้อมูลสำหรับ <strong>CA / Server Certificate</strong> ของโบรกเกอร์ดังกล่าว</p>
<ul>
<li>มีรูปการใช้คำสั่งแตกต่างไปจากโค้ดตัวอย่างแรกอยู่เล็กน้อย เช่น  มีการเปลี่ยนจากคลาส
<code>WiFiClient</code> มาใช้ <code>WiFiClientSecure</code> สำหรับตัวแปร <code>net</code> และใช้ <code>PubSubClient</code>
แทนที่ <code>MQTTClient</code> สำหรับตัวแปร <code>client</code> เป็นต้น</li>
<li>มีการใช้คำสั่ง <code>net.setCACert( MOSQUITTO_CERT_CA )</code> ในการเชื่อมต่อกับโบรกเกอร์
เพื่อระบุว่า จะใช้ข้อความที่เป็น <strong>CA Certificate</strong> ซึ่งอ้างอิงโดย <code>MOSQUITTO_CERT_CA</code></li>
</ul>
<p><strong>File:</strong> <code>esp32_mqtt_demo-2.ino</code></p>
<p><img alt="" src="arduino_esp32_pubsubclient_lib.png" /></p>
<p>รูป: ขั้นตอนการติดตั้งไลบรารี  <code>PubSubClient</code></p>
<pre><code class="language-cpp">#include &lt;WiFiClientSecure.h&gt; 
#include &lt;PubSubClient.h&gt; // https://github.com/knolleary/pubsubclient/
#include &quot;arduino_secrets.h&quot;

#define MQTT_BROKER    &quot;test.mosquitto.org&quot;
#define MQTT_PORT      (8883)

#define CLIENT_ID      &quot;arduino_client&quot;
#define SUB_TOPIC      &quot;test/1234/#&quot;
#define PUB_TOPIC      &quot;test/1234/msg&quot;
#define INTERVAL_MSEC  (5000)

WiFiClientSecure net;      // ESP32 WiFi client (Secure)
PubSubClient client(net);  // MQTT client
uint32_t last_pub_ts_msec = 0; 

void connect() {
  // connect the WiFi network first (if not already connected)
  while (WiFi.status() != WL_CONNECTED) {
    delay(1000);
  }
  Serial.print( &quot;\n\nWiFi Connected: &quot;);
  Serial.println( WiFi.localIP() ); // show the IP address

  // connect/reconnect the MQTT broker
  while ( !client.connect(CLIENT_ID, MQTT_USER, MQTT_PASS) ) {
    delay(1000);
  }
  client.subscribe( SUB_TOPIC );
}

// This is the callback function for the incoming MQTT message.
void onMessageReceived( char *topic, byte *payload, unsigned int length ) {
  uint32_t now_msec = millis(); // message reception timestamp
  ((char *)payload)[length] = '\0';
  Serial.printf( &quot;Received: topic='%s', payload='%s', rtt=%lu msec\n&quot;,
         topic, (char *)payload, now_msec-last_pub_ts_msec );
  Serial.flush();
}

void setup() {
  Serial.begin( 115200 );  // initialize the Serial port
  WiFi.mode( WIFI_STA );   // WiFi Station mode
  WiFi.begin( WIFI_SSID, WIFI_PASS ); // start the WiFi client

#if  defined(MQTT_PORT) &amp;&amp; (MQTT_PORT==8883 || MQTT_PORT==8884)
  net.setCACert( MOSQUITTO_CERT_CA );        // set the CA certificate
  #if (MQTT_PORT==8884)
    net.setCertificate( CLIENT_CERT_CRT );   // set client certificate
    net.setPrivateKey( CLIENT_PRIVATE_KEY ); // set private key 
  #endif
#endif

  // initialize the MQTT broker
  client.setServer( MQTT_BROKER, MQTT_PORT ); 
  // set the callback function
  client.setCallback( onMessageReceived ); 
  // set buffer size
  client.setBufferSize( 1024 );
  connect(); // connect the WiFi and the MQTT broker
}

void loop() {
  static uint32_t msg_cnt = 0; // published message count
  static char msg[32]; // message buffer (up to 32 chars)

  if ( !client.connected() ) { 
    connect();   // reconnect the WiFi and/or MQTT if disconnected
  }
  client.loop(); // process the MQTT event (non-blocking call)
  if ( millis() - last_pub_ts_msec &gt;= INTERVAL_MSEC ) {
    sprintf( msg, &quot;hello id=%lu&quot;, ++msg_cnt );
    Serial.printf( &quot;Published: '%s'\n&quot;, msg );
    Serial.flush();
    // update message publishing timestamp
    last_pub_ts_msec = millis(); 
    // publish a message 
    client.publish( PUB_TOPIC, msg );
  }
}
</code></pre>
<p>ในไฟล์ <code>arduino_secrets.h</code> มีการเพิ่มค่าคงที่ <code>MOSQUITTO_CERT_CA</code>
ซึ่งเป็นข้อความที่นำมาจากไฟล์ <code>mosquitto.org.crt</code> ตามตัวอย่างดังนี้</p>
<pre><code class="language-cpp">// Mosquitto Root CA: mosquitto.org.crt
// downloaded from http://test.mosquitto.org/ssl/mosquitto.org.crt
static const char MOSQUITTO_CERT_CA[] PROGMEM = R&quot;EOF(
-----BEGIN CERTIFICATE-----
MIIEAzCCAuugAwIBAgIUBY1hlCGvdj4NhBXkZ/uLUZNILAwwDQYJKoZIhvcNAQEL
BQAwgZAxCzAJBgNVBAYTAkdCMRcwFQYDVQQIDA5Vbml0ZWQgS2luZ2RvbTEOMAwG
A1UEBwwFRGVyYnkxEjAQBgNVBAoMCU1vc3F1aXR0bzELMAkGA1UECwwCQ0ExFjAU
BgNVBAMMDW1vc3F1aXR0by5vcmcxHzAdBgkqhkiG9w0BCQEWEHJvZ2VyQGF0Y2hv
by5vcmcwHhcNMjAwNjA5MTEwNjM5WhcNMzAwNjA3MTEwNjM5WjCBkDELMAkGA1UE
BhMCR0IxFzAVBgNVBAgMDlVuaXRlZCBLaW5nZG9tMQ4wDAYDVQQHDAVEZXJieTES
MBAGA1UECgwJTW9zcXVpdHRvMQswCQYDVQQLDAJDQTEWMBQGA1UEAwwNbW9zcXVp
dHRvLm9yZzEfMB0GCSqGSIb3DQEJARYQcm9nZXJAYXRjaG9vLm9yZzCCASIwDQYJ
KoZIhvcNAQEBBQADggEPADCCAQoCggEBAME0HKmIzfTOwkKLT3THHe+ObdizamPg
UZmD64Tf3zJdNeYGYn4CEXbyP6fy3tWc8S2boW6dzrH8SdFf9uo320GJA9B7U1FW
Te3xda/Lm3JFfaHjkWw7jBwcauQZjpGINHapHRlpiCZsquAthOgxW9SgDgYlGzEA
s06pkEFiMw+qDfLo/sxFKB6vQlFekMeCymjLCbNwPJyqyhFmPWwio/PDMruBTzPH
3cioBnrJWKXc3OjXdLGFJOfj7pP0j/dr2LH72eSvv3PQQFl90CZPFhrCUcRHSSxo
E6yjGOdnz7f6PveLIB574kQORwt8ePn0yidrTC1ictikED3nHYhMUOUCAwEAAaNT
MFEwHQYDVR0OBBYEFPVV6xBUFPiGKDyo5V3+Hbh4N9YSMB8GA1UdIwQYMBaAFPVV
6xBUFPiGKDyo5V3+Hbh4N9YSMA8GA1UdEwEB/wQFMAMBAf8wDQYJKoZIhvcNAQEL
BQADggEBAGa9kS21N70ThM6/Hj9D7mbVxKLBjVWe2TPsGfbl3rEDfZ+OKRZ2j6AC
6r7jb4TZO3dzF2p6dgbrlU71Y/4K0TdzIjRj3cQ3KSm41JvUQ0hZ/c04iGDg/xWf
+pp58nfPAYwuerruPNWmlStWAXf0UTqRtg4hQDWBuUFDJTuWuuBvEXudz74eh/wK
sMwfu1HFvjy5Z0iMDU8PUDepjVolOCue9ashlS4EB5IECdSR2TItnAIiIwimx839
LdUdRudafMu5T5Xma182OC0/u/xRlEm+tvKGGmfFcN0piqVl8OrSPBgIlb+1IKJE
m/XriWr/Cq4h/JfB7NTsezVslgkBaoU=
-----END CERTIFICATE-----
)EOF&quot;;
</code></pre>
<p>&nbsp;</p>
<p>โค้ดตัวอย่างนี้สามารถนำไปทดลองใช้กับ <strong>WokWi Simulator</strong> ได้
(เพิ่มรายการ <code>PubSubClient</code> ในไฟล์ <code>libraries.txt</code> และตั้งค่าชื่อ <strong>SSID</strong> เป็น
<code>"Wokwi-GUEST"</code> และรหัสผ่านเป็น <code>""</code>)</p>
<p><img alt="" src="wokwi_esp32_sim-1.png" /></p>
<p>รูป: การจำลองการทำงานด้วย <strong>WokWi Simulator</strong> และข้อความเอาต์พุต</p>
<p><img alt="" src="wokwi_esp32_sim-2.png" /></p>
<p>รูป: ไฟล์  <code>arduino_secrets.h</code> ใน  <strong>WokWi Simulator</strong></p>
<p>&nbsp;</p>
<hr />
<h2 id="_1">&#9655; <strong>กล่าวสรุป</strong><a class="headerlink" href="#_1" title="Permanent link">#</a></h2>
<p>บทความนี้สาธิตการติดตั้ง <strong>Mosquitto - MQTT Broker</strong> สำหรับระบบปฏิบัติการ <strong>Linux</strong>
และมีตัวอย่างการเขียนโค้ด <strong>Arduino</strong> สำหรับบอร์ดไมโครคอนโทรลเลอร์ <strong>ESP32</strong> เพื่อเชื่อมต่อกับ
<strong>WiFi</strong> และ <strong>Mosquitto</strong> ในระบบเครือข่ายเดียวกัน หรือเชื่อมต่อกับโบรกเกอร์สาธารณะ</p>
<p>&nbsp;</p>
<hr />
<p>This work is licensed under a Creative Commons Attribution-ShareAlike 4.0 International License.</p>
<p>Created: 2022-09-17 | Last Updated: 2022-09-17</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2021-2022 IoT Engineering Education, Bangkok/Thailand</a></p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
