<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="RSP">
        <link rel="canonical" href="http://iot-kmutnb.github.com/blogs/arduino/avr_debugger/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>ตัวเลือกสำหรับการดีบักการทำงานของโปรแกรมในไมโครคอนโทรลเลอร์ **AVR** - IoT Engineering Education</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../../css/extra.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/c.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/cpp.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/arduino.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/typescript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/json.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/vhdl.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/verilog.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/text.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/matlab.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/julia.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-966FQ6RN6W"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-966FQ6RN6W');
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">IoT Engineering Education</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#avr" class="nav-link">ตัวเลือกสำหรับการดีบักการทำงานของโปรแกรมในไมโครคอนโทรลเลอร์ AVR</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#avr_1" class="nav-link">&#9655; การดีบักโปรแกรม AVR</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#ocd-avr" class="nav-link">&#9655; การทำงานของวงจร OCD ภายในชิป AVR</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#avr_2" class="nav-link">&#9655; ตัวเลือกอื่นสำหรับดีบักโปรแกรม AVR</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#avr-debug-simavr-vs-code-ide-platformio" class="nav-link">&#9655; ตัวอย่างการใช้งาน avr-debug และ simavr สำหรับ VS Code IDE + PlatformIO</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_1" class="nav-link">&#9655; กล่าวสรุป</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="avr">ตัวเลือกสำหรับการดีบักการทำงานของโปรแกรมในไมโครคอนโทรลเลอร์ <strong>AVR</strong><a class="headerlink" href="#avr" title="Permanent link">#</a></h1>
<hr />
<h2 id="avr_1">&#9655; <strong>การดีบักโปรแกรม AVR</strong><a class="headerlink" href="#avr_1" title="Permanent link">#</a></h2>
<p>ก่อนอื่นมาทำความรู้จักหรือทบทวนคำศัพท์เกี่ยวกับไมโครคอนโทรลเลอร์ <strong>Atmel / Microchip AVR</strong> ดังนี้</p>
<ul>
<li><strong>AVR</strong> หมายถึง ชื่อสถาปัตยกรรมของซีพียูที่ได้มีการออกแบบโดยบริษัท <strong>Atmel</strong> 
(ในปัจจุบันได้ถูกรวมเป็นส่วนหนึ่งของบริษัท <strong>Microchip</strong>) จัดอยู่ในประเภท <strong>RISC</strong> 
(<em>Reduced Instruction Set Computer</em>) และมีขนาด 8 บิต</li>
<li><strong>ATtiny / tinyAVR (0/1/2-Series)</strong>, <strong>ATmega / megaAVR</strong>,
<strong>ATxmega / AVR XMEGA</strong> และ <strong>AVR-DA / AVR-DB</strong>
เป็นชื่อตระกูลของชิปไมโครคอนโทรลเลอร์ (<strong>MCU Series / Families</strong>) ของบริษัท <strong>Atmel/Microchip</strong>
ที่ใช้ซีพียูตามสถาปัตยกรรมของ <strong>AVR</strong></li>
<li>ชิปไมโครคอนโทรลเลอร์ในตระกูล <strong>ATmega</strong> ที่ได้รับความนิยมในช่วงหลายปีที่ผ่านมา คือ <strong>ATmega328P</strong>, <strong>ATmega32U4</strong>,
<strong>ATmega2560</strong> เนื่องจากได้มีการนำไปใช้กับบอร์ด <strong>Arduino Uno / Nano</strong>, <strong>Pro Micro</strong>, 
และ <strong>MEGA2560</strong> </li>
<li><strong>On-Chip Debug (OCD)</strong> เป็นความสามารถของชิปไมโครคอนโทรลเลอร์ <strong>AVR</strong>
ที่รองรับการดีบักหรือรันคำสั่งในระดับล่างของโปรแกรมโดยใช้ฮาร์ดแวร์จริง ทำไปทีละคำสั่ง หรือสั่งให้รันแล้วสามารถหยุดชั่วคราวตามเงื่อนไขที่กำหนดไว้ได้ 
จากนั้นจึงดูหรือตรวจสอบสถานะภายในของไมโครคอนโทรลเลอร์ได้ เช่น การเข้าถึง-เขียนหรืออ่านค่าในรีจิสเตอร์ของซีพียู 
(<strong>Program Counter</strong>, <strong>Stack Pointer</strong>, <strong>Status Register</strong>, 
<strong>I/O Registers</strong>, …) รวมถึงหน่วยความจำแฟลช (<strong>Flash Memory</strong>) และหน่วยความจำเอสแรม (<strong>SRAM</strong>) </li>
</ul>
<p>การเขียนโค้ด (เรียกว่า <strong>Application Code</strong>) และแปลงให้เป็นโปรแกรมหรือไฟล์เฟิร์มแวร์ 
สำหรับชิปไมโครคอนโทรลเลอร์ <strong>AVR</strong> มีตัวเลือกที่เป็นซอฟต์แวร์ เช่น</p>
<ul>
<li><a href="https://www.microchip.com/en-us/tools-resources/develop/microchip-studio"><strong>Microchip/Atmel AVR Studio</strong></a></li>
<li><a href="https://gcc.gnu.org/wiki/avr-gcc"><strong>GCC-AVR Toolchain</strong></a> </li>
<li><a href="https://github.com/arduino/ArduinoCore-avr"><strong>Arduino-AVR</strong></a> + <a href="https://www.arduino.cc/en/software/"><strong>Arduino IDE</strong></a>
    สามารถนำมาใช้ร่วมกับ <strong>VS Code IDE + PlatformIO</strong> ได้</li>
</ul>
<p>ปรกติการเขียนโค้ดสำหรับไมโครคอนโทรลเลอร์ เช่น <strong>Arduino</strong> ก็มักจะใช้หรือเพิ่มคำสั่งลงในโค้ด เช่น <strong>Serial.print()</strong>
เพื่อส่งข้อความมายัง <strong>Arduino Serial Monitor</strong> และข้อความเหล่านั้นก็จะแสดงสถานะการทำงานในแต่ละช่วงของโปรแกรม
เช่น แสดงค่าของตัวแปรในขณะนั้น เป็นต้น โปรแกรมก็จะทำงานต่อเนื่องไปไม่หยุด หลายคนก็คงใช้วิธีนี้</p>
<p>การดีบักโค้ดหรือโปรแกรมสำหรับไมโครคอนโทรลเลอร์มีหลายวิธีให้เลือก แบ่งเป็น 2 ประเภทหลักได้แก่</p>
<ol>
<li>การใช้ซอฟต์แวร์จำลองการทำงาน เรียกว่า <strong>Instruction-Set Simulator</strong> หรือตัวจำลองการทำงานของโปรแกรมตามคำสั่งระดับล่างของซีพียู
ถ้าเป็นตัวจำลองการทำงานสำหรับชิปไมโครคอนโทรลเลอร์ ก็จะรวมถึงวงจรรอบข้างด้วย (<strong>Peripherals</strong>)</li>
<li>การใช้ฮาร์ดแวร์อัปโหลดโปรแกรมไปยังบอร์ดคอนโทรลเลอร์และควบคุมการทำงานของโปรแกรมในฮาร์ดแวร์</li>
</ol>
<p>ทั้งสองวิธี จะทำให้ผู้ใช้สามารถหยุดการทำงานของโปรแกรมชั่วคราวได้ กำหนดตำแหน่งหรือเงื่อนไขเพื่อให้หยุดชั่วคราวได้
ทั้งสองวิธีก็มีข้อดีข้อเสียแตกต่างกัน และก็ขึ้นอยู่กับชิปหรือบอร์ดไมโครคอนโทรลเลอร์ที่ได้นำมาใช้งานด้วย
ในกรณีที่ต้องการดีบักการทำงานของโปรแกรมในฮาร์ดแวร์ ก็ต้องมีอุปกรณ์เสริมด้วย</p>
<p>เมื่อคอมไพล์โค้ดแล้วได้มาเป็นไฟล์ประเภท <strong>.elf</strong> หรือ <strong>.hex</strong>
ถ้าต้องการดีบักการทำงานของชิป <strong>AVR</strong> ก็มีตัวเลือก เช่น</p>
<ul>
<li>การใช้โปรแกรมในการจำลองการทำงานไปทีละคำสั่ง (เรียกว่า <strong>AVR Instruction-Set Simulator</strong>)
ไม่ต้องใช้อุปกรณ์ฮาร์ดแวร์จริง โดยเลือกใช้ซอฟต์แวร์ เช่น<ul>
<li><a href="https://www.microchip.com/en-us/tools-resources/develop/microchip-studio"><strong>Microchip/Atmel Studio IDE</strong></a>
          ซึ่งมี <strong>Built-in Simulator</strong> มาให้ใช้งานได้ฟรี </li>
<li><a href="https://wokwi.com/"><strong>"Wokwi" &mdash; Online AVR Simulator</strong></a>
ใช้งานได้ฟรีบนเว็บเบราว์เซอร์ และใช้ <a href="https://github.com/wokwi/avr8js"><strong>avr8js</strong></a> ที่เขียนด้วยภาษา <strong>JavaScript</strong> เป็นพื้นฐานในการทำงาน  </li>
<li><a href="https://github.com/buserror/simavr"><strong>"simavr" &mdash; Opensource AVR Simulator</strong></a></li>
</ul>
</li>
<li>การใช้ฮาร์ดแวร์ในการดีบักโปรแกรม (<strong>Hardware Debugger / In-Circuit Debugger</strong>) 
เช่น การเชื่อมต่อกับชิป <strong>AVR</strong> และวงจรภายในที่เรียกว่า <strong>OCD (On-Chip Debug System)</strong></li>
</ul>
<p><img alt="" src="../avr/images/microchip_studio_avr-6.png" /></p>
<p>รูป: ตัวอย่างการจำลองการทำงานของโปรแกรมสำหรับ <strong>AVR</strong> โดยใช้ <strong>Microchip Studio IDE</strong></p>
<p><img alt="" src="../avr/images/mplabx_avr-10.png" /></p>
<p>รูป: ตัวอย่างการจำลองการทำงานของโปรแกรมสำหรับ <strong>AVR</strong> โดยใช้ <strong>Microchip MPLAB-X</strong></p>
<p><img alt="" src="../avr/images/wokwi-avr-7.png" /></p>
<p>รูป: ตัวอย่างการจำลองการทำงานของโปรแกรมสำหรับ <strong>AVR</strong> โดยใช้ <strong>Wokwi Simulator - Online GDB Debugger</strong></p>
<p>การกำหนดเงื่อนไขให้ซีพียู หรือ โปรแกรมจำลองการทำงาน หยุดทำคำสั่งชั่วคราว หรือที่เรียกว่า <strong>Breakpoints</strong>
มีหลายรูปแบบ เช่น การกำหนดตำแหน่งในโค้ดหรือแอดเดรส (<strong>Address / Memory Location</strong>) 
ในหน่วยความจำสำหรับโปรแกรม (<strong>Program Memory</strong>) และนำไปใช้ในการเปรียบเทียบกับค่าของรีจิสเตอร์ที่เรียกว่า 
<strong>Program Counter (PC)</strong> ซึ่งเก็บแอดเดรสในหน่วยความจำของคำสั่งถัดไป 
เมื่อทำคำสั่งมาถึงตำแหน่งดังกล่าว จะได้ค่าตรงกัน ก็ทำให้ซีพียูหยุดการทำงานชั่วคราว และเรียกเงื่อนไขการหยุดแบบนี้ว่า 
<strong>Program Counter Breakpoint</strong></p>
<p>&nbsp;</p>
<hr />
<h2 id="ocd-avr">&#9655; <strong>การทำงานของวงจร OCD ภายในชิป AVR</strong><a class="headerlink" href="#ocd-avr" title="Permanent link">#</a></h2>
<p>วงจร <strong>OCD</strong> ภายในชิป <strong>AVR</strong>  จะต้องเชื่อมต่อกับอุปกรณ์ <strong>Hardware Debugger</strong>
เช่น <strong>Atmel-ICE Debugger (JTAGICE3)</strong> 
ซึ่งรองรับการเชื่อมต่อกับชิปได้หลายรูปแบบ เช่น  เช่น <strong>JTAG (IEEE Standard 1149.1)</strong>, 
<strong>debugWIRE</strong>, <strong>PDI</strong>, <strong>UPDI</strong> เป็นต้น 
และอุปกรณ์นี้เชื่อมต่อกับซอฟต์แวร์ เช่น <strong>Microchip Studio IDE</strong> 
ในเครื่องคอมพิวเตอร์ของผู้ใช้ผ่านทางพอร์ต <strong>USB</strong></p>
<p><img alt="" src="../avr/images/avr_jtag_ocd.png" /></p>
<p>รูป: แสดงผังองค์ประกอบภายในของชิป <strong>ATmega</strong> ในส่วนที่เกี่ยวข้องกับ <strong>JTAG-OCD</strong></p>
<p><img alt="" src="../avr/images/avr_debugwire.png" /></p>
<p>รูป:  แสดงผังองค์ประกอบภายในของชิป <strong>ATmega</strong> ในส่วนที่เกี่ยวข้องกับ <strong>debugWIRE</strong></p>
<p><img alt="" src="avr/images/arduino_atmel_programmer.png" /></p>
<p>รูป: ตัวอย่างอุปกรณ์ <strong>Atmel JTAG-ICE</strong> ที่กำลังเชื่อมต่อกับบอร์ด <strong>Arduino Uno</strong>
ผ่านทางคอนเนกเตอร์ <strong>ICSP</strong></p>
<p>&nbsp;</p>
<p>ชิป <strong>AVR</strong> แต่ละรุ่น มีวงจร <strong>OCD</strong> ที่เชื่อมต่อด้วยวิธีที่ได้แตกต่างกัน ขึ้นอยู่กับความจุของหน่วยความจำและจำนวนขา เช่น</p>
<ul>
<li><strong>ATmega328P</strong> มีวงจร <strong>OCD</strong> ที่เชื่อมต่อผ่านทาง <strong>debugWIRE</strong> เท่านั้น 
(สำหรับชิป <strong>AVR</strong> ที่มีขา <strong>I/O</strong> และหน่วยความจำค่อนข้างจำกัด) และต้องใช้ขา <strong>/RESET</strong> 
ในการเชื่อมต่อกับอุปกรณ์ที่ทำงานที่เป็น <strong>Hardware Debugger</strong> และต้องมีการเขียนค่าบิตฟิวส์ (<strong>Fuse bit</strong>) 
ที่มีชื่อว่า <strong><code>DWEN</code> Fuse (debugWIRE Enable)</strong> เพื่อเปิดใช้งานสำหรับการดีบัก</li>
<li><strong>ATmega2560</strong> มีวงจร <strong>OCD</strong> ที่เชื่อมต่อได้ผ่านทาง <strong>JTAG</strong> เท่านั้น และต้องมีการเขียนค่าบิตฟิวส์ 
<strong><code>OCDEN</code> Fuse</strong> และ <strong><code>JTAGEN</code> Fuse</strong> เพื่อเปิดใช้งานสำหรับการดีบัก </li>
<li><strong>ATxmega</strong> สามารถใช้งานวงจรดีบักภายในได้โดยใช้ช่องทาง <strong>JTAG</strong> และ <strong>PDI</strong> 
(<em>Program and Debug Interface</em>)</li>
<li><strong>ATmega4808/4809</strong> มีวงจรดีบักภายในที่ใช้ขา <strong>UPDI</strong> 
(<em>Unified Program and Debug Interface</em>) ซึ่งแตกต่างจาก <strong>PDI</strong> ที่ใช้สายสัญญาณ 2 เส้น
(<strong>2-wire Debug Interface</strong>) แต่ <strong>UPDI</strong> ใช้สายสัญญาณเพียงเส้นเดียว และใช้วิธีสื่อสารข้อมูลแบบ 
<strong>Half-duplex UART Protocol</strong></li>
</ul>
<p>วงจร <strong>AVR-JTAG-OCD</strong> มีกลุ่มของรีจิสเตอร์ที่เกี่ยวข้องในการทำงาน สามารถเขียนและอ่านค่าผ่านทาง 
<strong>JTAG Scan Chain</strong> เท่านั้น เช่น </p>
<ul>
<li><em>Break Status Register</em></li>
<li><em>Break Control Register</em></li>
<li><em>Program or Data Memory Set Breakpoint Registers</em></li>
<li><em>OCD Readback Register</em></li>
<li><em>OCD Control and Status Register</em></li>
</ul>
<p>วงจร <strong>Break Point Unit</strong> ซึ่งเป็นส่วนหนึ่งของวงจร <strong>OCD</strong> และเชื่อมต่อผ่านทาง <strong>JTAG</strong>
รองรับการกำหนดเงื่อนไขเพื่อให้โปรแกรมหยุดชั่วคราว ดังนี้</p>
<ul>
<li><strong>Breakpoints in Data Memory vs. Program Memory</strong>: 
การกำหนดเงื่อนไขการหยุดชั่วคราวโดยดูจากแอดเดรสในหน่วยความจำแฟลช (<strong>Program Memory</strong>) 
หรือหน่วยความจำแบบ <strong>SRAM</strong> (<strong>Data Memory</strong>) </li>
<li><strong>Single Breakpoints vs. Range Breakpoints</strong>: 
การตรวจสอบเพียงแอดเดรสเดียว หรือตรวจสอบช่วงของแอดเดรส (<strong>Address Range</strong>)</li>
</ul>
<p>การกำหนดเงื่อนไขเพื่อหยุดการทำงานของโปรแกรมชั่วคราวในลักษณะนี้ เรียกว่า <strong>Hardware Breakpoints</strong>
แต่สามารถใช้ได้จำนวนจำกัด (เช่น ในกรณีที่ใช้ชิป  <strong>ATmega / ATxmega</strong> จะได้สูงสุด 4 เงื่อนไขพร้อมกัน)</p>
<p>นอกจาก <strong>Hardware Breakpoints</strong> แล้ว ยังมีอีกรูปแบบหนึ่งคือ 
<strong>Software Breakpoints</strong> ถ้าเป็นชิป <strong>AVR</strong> ก็จะใช้คำสั่ง <code>break</code> 
และสามรถใช้ได้ไม่จำกัดจำนวนในโปรแกรม เมื่อได้ทำคำสั่งดังกล่าว ก็จะทำให้ซีพียูหยุดการทำคำสั่งต่อไปชั่วคราว</p>
<pre><code class="language-cpp">// an inline assembly instruction in C code for gcc-avr
asm(&quot;break&quot;);
</code></pre>
<p>&nbsp;</p>
<hr />
<h2 id="avr_2">&#9655; <strong>ตัวเลือกอื่นสำหรับดีบักโปรแกรม AVR</strong><a class="headerlink" href="#avr_2" title="Permanent link">#</a></h2>
<p><a href="https://github.com/felias-fogg/dw-link"><strong>"dw-link"</strong></a>
(<strong>Arduino-based AVR-debugWIRE Debugger</strong>) เป็น <strong>Arduino Sketch</strong>
ที่สามารถนำไปใช้กับบอร์ด <strong>Arduino Uno / Nano / Pro Mini</strong> เพื่อทำให้บอร์ดดังกล่าวกลายเป็นอุปกรณ์ 
<strong>Hardware Debugger</strong> สำหรับไมโครคอนโทรลเลอร์ <strong>AVR</strong></p>
<p><strong>"dw-link"</strong> ทำหน้าที่เชื่อมต่อกับคอมพิวเตอร์ของผู้ใช้ผ่านทาง <strong>USB-to-serial</strong> 
สามารถสื่อสารไปยังโปรแกรม <strong>GNU Debugger for AVR</strong> (<code>avr-gdb</code>) 
ด้วยโพรโทคอลที่เรียกว่า <strong>GDB RSP</strong> (<em>Remote Serial Protocol</em>) และอีกด้านหนึ่งของอุปกรณ์ดีบักเกอร์เชื่อมต่อกับไมโครคอนโทรลเลอร์เป้าหมาย โดยใช้ <strong>debugWIRE</strong> 
(ใช้สายสัญญาณเพียงหนึ่งเส้น) อุปกรณ์นี้สามารถนำไปใช้งานกับคำสั่ง <code>avr-gdb</code> แบบ <strong>Command Line</strong> หรือใช้ร่วมกับ 
<strong>VS Code IDE + PlatformIO</strong></p>
<p><a href="https://github.com/avrdudes/avarice"><strong>"AVaRICE"</strong></a> (<strong>Atmel JTAG-ICE to GDB Interfacing</strong>)
เป็นอีกหนึ่งโปรแกรมที่ทำหน้าที่เป็นตัวกลางเชื่อมต่อกับอุปกรณ์ <strong>Atmel JTAG ICE mkII</strong> ไปยังโปรแกรม <strong>GDB</strong>
เพื่อดีบักการทำงานของโปรแกรมในชิป <strong>AVR</strong> และสามารถนำไปใช้งานกับ <strong>VS Code IDE + PlatformIO</strong></p>
<p><a href="https://github.com/jdolinay/avr_debug/"><strong>avr-debug</strong></a>
(<code>avr-stub.h</code>) ซึ่งได้มีการพัฒนาโดย <a href="https://fai.utb.cz/en/contacts/ing-jan-dolinay-ph-d-2/"><strong>Jan Dolinay</strong></a> 
มาตั้งแต่ปีค.ศ. 2015 เป็นไลบรารีสำหรับ <strong>Arduino</strong> ที่ช่วยให้ผู้ใช้สามารถดีบักโปรแกรมที่ทำงานด้วยชิป <strong>ATmega328P</strong>
บนบอร์ด <strong>Arduino Uno / Nano</strong> หรือชิป <strong>ATmega2560</strong> บนบอร์ด <strong>Arduino MEGA2560</strong>
โดยไม่ต้องมีอุปกรณ์เสริม และใช้เพียงช่องทาง <strong>USB-to-Serial</strong> เท่านั้น</p>
<p>โค้ด <strong>Arduino Sketch</strong> จะต้องมีการใช้คำสั่ง <code>debug_init()</code> สำหรับการเชื่อมต่อกับ <strong>AVR GDB Debugger</strong>
ในเครื่องคอมพิวเตอร์ของผู้ใช้ และโค้ดส่วนนี้เรียกว่า <strong>GDB Debugging Agent for ATMega328 (avr-gdb stub)</strong>
ถ้าต้องการกำหนดตำแหน่งการหยุดชั่วคราวในโค้ด ก็ให้เพิ่มคำสั่ง  <code>breakpoint()</code></p>
<p>ข้อจำกัดอย่างหนึ่งของการใช้ <strong>avr-debug</strong> คือ คำสั่งที่ใช้ <code>Serial</code> ของ <strong>Arduino</strong> 
จะไม่สามารถใช้ได้ เนื่องจากวงจร <strong>USART</strong> ของ <strong>AVR</strong> จะถูกใช้สำหรับการดีบัก </p>
<p>การใช้ <strong>avr-gdb stub</strong> ใน <strong>Arduino Sketch</strong> ยังทำให้มีการใช้หน่วยความจำเพิ่มขึ้น (<strong>Memory Overhead</strong>) ประมาณ
<strong>4650 ~ 5500</strong> ไบต์สำหรับ <strong>Flash</strong> และ <strong>270 ~ 350</strong> ไบต์สำหรับ <strong>SRAM</strong></p>
<p>ศึกษาเพิ่มเติมเกี่ยวกับ <strong>avr-debug</strong> ได้จาก</p>
<ul>
<li>Jan Dolinay et al., <a href="https://thesai.org/Downloads/Volume12No2/Paper_4-Advanced_Debugger_for_Arduino.pdf">"<strong>Advanced Debugger for Arduino</strong>"</a>, 
 International Journal of Advanced Computer Science and Applications(IJACSA), Volume 12 Issue 2, 2021.</li>
<li>Jan Dolinay, <strong>Creating and Debugging Arduino Programs in Visual Studio Code (2019)</strong>:
<a href="https://www.codeproject.com/Articles/5150391/Creating-and-Debugging-Arduino-Programs-in-Visual">Part 1</a> &amp;
<a href="https://www.codeproject.com/Articles/5160447/Creating-and-Debugging-Arduino-Programs-in-Visua-2">Part 2</a></li>
</ul>
<p>&nbsp;</p>
<hr />
<h2 id="avr-debug-simavr-vs-code-ide-platformio">&#9655; <strong>ตัวอย่างการใช้งาน avr-debug และ simavr สำหรับ VS Code IDE + PlatformIO</strong><a class="headerlink" href="#avr-debug-simavr-vs-code-ide-platformio" title="Permanent link">#</a></h2>
<p>ตัวอย่างการใช้งาน  สามารถดูได้จากเอกสารออนไลน์ของ 
<a href="https://docs.platformio.org/en/stable/plus/debug-tools/avr-stub.html"><strong>PlatformIO &gt; Debug Tools &gt; avr-debug</strong></a>
เริ่มต้นด้วยการสร้างโปรเจกต์ใหม่ และเลือกบอร์ด เช่น <strong>Arduino Nano (328P, New Bootloader)</strong></p>
<p><img alt="" src="../avr/images/avr_debug_vscode_pio-1.png" /></p>
<p>รูป: เริ่มต้นสร้างโปรเจกต์ใหม่ เลือกบอร์ด <strong>Arduino Nano (new)</strong> และใช้ <strong>Arduino Framework</strong>
สำหรับการเขียนโค้ด</p>
<p>ลองใช้ตัวอย่างโค้ดในไฟล์ <code>main.cpp</code></p>
<pre><code class="language-cpp">#include &lt;Arduino.h&gt;

#define USE_AVR_DEBUG

#ifdef USE_AVR_DEBUG
#include &quot;avr8-stub.h&quot;
#endif 

// Constant
const int PWM_LED_PIN = 5;
// Global variables
uint8_t led_state = 0;
volatile uint8_t pwm_value = 0;

void setup() {
#ifdef USE_AVR_DEBUG
  debug_init(); // Initialize GDB stub
  delay(1000);
#endif
  pinMode(LED_BUILTIN, OUTPUT);
  pinMode(PWM_LED_PIN, OUTPUT);
  digitalWrite(PWM_LED_PIN, HIGH );
}

void loop() {
  static uint8_t index = 0;
#ifdef USE_AVR_DEBUG
  breakpoint(); // Add breakpoint 
#endif
  digitalWrite(LED_BUILTIN, led_state ^= 1); // Toggle the LED
  pwm_value = 255*(1-sin(index*PI/16));
  index = (index+1) % 16;
  analogWrite( PWM_LED_PIN, pwm_value ); // Update PWM output
  delay(100);
}
</code></pre>
<p>ตัวอย่างไฟล์ <code>platformio.ini</code> สำหรับการดีบัก
บอร์ด <strong>Arduino Nano (328P, New Bootloader)</strong> ด้วย <strong>avr-debug</strong> มีดังนี้
ผู้ใช้จะต้องกำหนดหมายเลขพอร์ตให้ตรงกับบอร์ดที่ใช้งานจริง (ในตัวอย่างนี้ใช้ <code>COM66</code>)</p>
<p>การตั้งค่า <code>AVR8_BREAKPOINT_MODE=1</code> เป็นการเลือกใช้ <strong>SRAM Breakpoints</strong>
เมื่อซีพียูทำคำสั่งหนึ่งคำสั่งจะถูกหยุดโดยอินเทอร์รัพท์และให้ฟังก์ชัน <strong>ISR</strong> ที่เกี่ยวข้องกับการทำงานของดีบักเกอร์ 
ตรวจสอบดูว่า ได้ทำคำสั่งมาถึงตำแหน่งที่ผู้ใช้ได้กำหนดให้เป็น <strong>Breakpoint</strong> แล้วหรือไม่ ถ้าไม่ใช่ก็ให้ทำต่อไป
ดังนั้นโหมดนี้จะทำงานได้ช้ากว่าอีกโหมดหนึ่งที่เรียกว่า <strong>Flash Breakpoints</strong></p>
<pre><code>[env:avrdebug]
platform    = atmelavr
board       = nanoatmega328new
framework   = arduino
;debug_tool = simavr
debug_tool  = avr-stub
; specify the actual Serial COM port
upload_protocol = arduino
upload_port = \\.\COM66
debug_port  = \\.\COM66
build_type = debug
debug_build_flags =
  -Og -ggdb -g3
debug_init_break = tbreak setup
build_flags =
  -DAVR8_BREAKPOINT_MODE=1
lib_deps =
    jdolinay/avr-debugger @ ~1.5
</code></pre>
<p><img alt="" src="../avr/images/avr_debug_vscode_pio-2.png" /></p>
<p>รูป: ทำขั้นตอนดีบัก (<strong>PIO &gt; Debug &gt; Start Debugging</strong>) 
และมาหยุดเมื่อได้ทำคำสั่ง <code>breakpoint()</code></p>
<p><img alt="" src="../avr/images/avr_debug_vscode_pio-3.png" /></p>
<p>รูป: ดูค่าของตัวแปรที่มีการใช้ในโค้ด <code>main.cpp</code></p>
<p>แต่ถ้าต้องการลองใช้ <code>simavr</code> แทน <code>avr-debug</code> ในไฟล์ <code>platformio.ini</code> ก็ตั้งค่าใหม่ดังนี้</p>
<pre><code>debug_tool  = simavr
;debug_tool  = avr-stub
;debug_port  = ...
</code></pre>
<p><img alt="" src="../avr/images/simavr_vscode_pio-1.png" /></p>
<p>รูป: การดีบักด้วยโปรแกรมจำลองการทำงาน <strong>simavr</strong></p>
<p><img alt="" src="../avr/images/simavr_vscode_pio-2.png" /></p>
<p>รูป: ตัวอย่างการเข้าไปภายในฟังก์ชันเพื่อทำคำสั่ง (<strong>Step Into</strong>) ขณะจำลองการทำงานของโปรแกรม</p>
<p>&nbsp;</p>
<hr />
<h2 id="_1">&#9655; <strong>กล่าวสรุป</strong><a class="headerlink" href="#_1" title="Permanent link">#</a></h2>
<p>บทความนี้ได้นำเสนอตัวเลือกสำหรับการดีบักโปรแกรมสำหรับชิปไมโครคอนโทรลเลอร์ <strong>AVR</strong>
ที่เขียนโค้ดด้วย <strong>Arduino Sketch</strong>
และได้สาธิตการใช้งาน <strong>avr-debug</strong>  และ <strong>simavr</strong> ร่วมกับซอฟต์แวร์
<strong>VS Code IDE + PlatformIO extension</strong></p>
<p>&nbsp;</p>
<hr />
<p><em>This work is licensed under a</em> <strong><em>Creative Commons Attribution-ShareAlike 4.0 International License</em></strong>.</p>
<p>Created: 2023-02-01 | Last Updated: 2023-02-02</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2021-2023 IoT Engineering Education, Bangkok/Thailand</a></p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
