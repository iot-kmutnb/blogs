<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="RSP">
        <link rel="canonical" href="https://iot-kmutnb.github.io/blogs/arduino/arduino_led_blink/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>การเขียนโค้ด Arduino สำหรับ LED Blink ด้วยวิธีที่แตกต่างกัน - IoT Engineering Education</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../../css/extra.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/c.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/cpp.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/arduino.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/typescript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/json.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/rust.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/vhdl.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/verilog.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/text.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/matlab.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/julia.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-966FQ6RN6W"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', 'G-966FQ6RN6W');
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">IoT Engineering Education</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#arduino-led-blink" class="nav-link">การเขียนโค้ด Arduino สำหรับ LED Blink ด้วยวิธีที่แตกต่างกัน</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#1" class="nav-link">&#9655; ตัวอย่างที่ 1</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#2" class="nav-link">&#9655; ตัวอย่างที่ 2</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#3" class="nav-link">&#9655; ตัวอย่างที่ 3</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#4" class="nav-link">&#9655; ตัวอย่างที่ 4</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#5" class="nav-link">&#9655; ตัวอย่างที่ 5</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#6" class="nav-link">&#9655; ตัวอย่างที่ 6</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#7" class="nav-link">&#9655; ตัวอย่างที่ 7</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#8" class="nav-link">&#9655; ตัวอย่างที่ 8</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#9" class="nav-link">&#9655; ตัวอย่างที่ 9</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_1" class="nav-link">&#9655; กล่าวสรุป</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="arduino-led-blink">การเขียนโค้ด Arduino สำหรับ LED Blink ด้วยวิธีที่แตกต่างกัน<a class="headerlink" href="#arduino-led-blink" title="Permanent link">#</a></h1>
<p>บทความนี้นำเสนอตัวอย่างการเขียนโค้ด <strong>Arduino Sketch</strong> เพื่อทำให้ <strong>LED</strong> 
บนบอร์ดไมโครคอนโทรลเลอร์ <strong>Arduino Uno / Nano</strong> กระพริบด้วยอัตราคงที่ โดยใช้วิธีที่แตกต่างกันมากกว่าหนึ่งวิธี
โค้ดตัวอย่างในบทความนี้สามารถนำไปทดลองได้กับ <a href="https://wokwi.com/"><strong>WokWi Simulator</strong></a>
เพื่อจำลองการทำงานเสมือนจริง และ <strong>Arduino IDE</strong> เพื่อนำไปอัปโหลดไปยังบอร์ดไมโครคอนโทรลเลอร์ </p>
<p><strong>Keywords</strong>: <em>Arduino Nano / Uno</em>, <em>Arduino Sketch</em>, 
<em>LED Blink</em>, <em>WokWi Simulator</em></p>
<hr />
<h2 id="1">&#9655; <strong>ตัวอย่างที่ 1</strong><a class="headerlink" href="#1" title="Permanent link">#</a></h2>
<p>โค้ดตัวอย่างแรกเริ่มต้นด้วยการสร้างฟังก์ชัน <code>setup()</code> ที่มีการกำหนดให้ขา <code>LED_PIN</code> 
ซึ่งตรงกับ <code>LED_BUILTIN</code> เป็นเอาต์พุตแบบดิจิทัล และเขียนค่าเอาต์พุตให้เป็น <code>LOW</code>
โดยใช้คำสั่ง <code>digitalWrite( LED_PIN, LOW );</code>
ถัดไปเป็นฟังก์ชัน <code>loop()</code> ซึ่งจะถูกเรียกให้ทำงานซ้ำโดยอัตโนมัติ
ภายในมีคำสั่งที่เรียกฟังก์ชัน <code>led_blink1( LED_PIN );</code> </p>
<p>ในส่วนของการสร้างฟังก์ชัน <code>void led_blink1( int pin ) { ... }</code> 
มีการทำคำสั่ง <code>digitalWrite(...);</code>
เพื่อกำหนดสถานะลอจิก <code>HIGH</code> หรือ <code>LOW</code> ของขาที่ระบุโดยตัวแปรหรืออาร์กิวเมนต์ชื่อ <code>pin</code> และคำสั่ง <code>delay( DELAY_MS );</code>
เพื่อการหน่วงเวลาไว้เท่ากับค่าตัวเลขของ <code>DELAY_MS</code> ก่อนทำคำสั่งต่อไปตามลำดับ</p>
<pre><code class="language-c">#define LED_PIN   (LED_BUILTIN) // the default LED pin
#define DELAY_MS  (500)

void setup() {
  // Set the LED pin direction to output
  pinMode( LED_PIN, OUTPUT );
  // Output LOW to the LED pin
  digitalWrite( LED_PIN, LOW );
}

void loop() {
  led_blink1( LED_PIN );
}

void led_blink1( int pin ) {
  // Output HIGH to the LED pin
  digitalWrite( pin, HIGH );
  // Delay for a few hundred milliseconds
  delay( DELAY_MS );
  // Output LOW to the LED pin
  digitalWrite( pin, LOW );
  // Delay for a few hundred milliseconds
  delay( DELAY_MS );
}
</code></pre>
<p><img alt="" src="wokwi_sim_arduino_nano-1.png" /></p>
<p>รูป: ตัวอย่างการจำลองการทำงานของโค้ดโดยใช้ <strong>WokWi Simulator</strong></p>
<p>&nbsp;</p>
<hr />
<h2 id="2">&#9655; <strong>ตัวอย่างที่ 2</strong><a class="headerlink" href="#2" title="Permanent link">#</a></h2>
<p>ในโค้ดตัวอย่างนี้ มีการสร้างฟังก์ชันและเรียกใช้ <code>led_blink2(...)</code> มาแทนที่และเปรียบเทียบกับฟังก์ชัน <code>led_blink1(...)</code> ในตัวอย่างแรก
แต่มีรูปแบบการเขียนโค้ดที่แตกต่างกัน ซึ่งมีการประกาศและใช้งานตัวแปรภายในฟังก์ชันและเป็นแบบ <code>static</code> ที่มีชื่อว่า <code>state</code> 
เพื่อใช้กำหนดสถานะลอจิกของขาเอาต์พุต <code>LED_PIN</code></p>
<p>ตัวแปร <code>state</code> จะถูกสร้างขึ้นให้มีค่าเริ่มต้นเป็น 0 และสามารถเก็บค่าในหน่วยความจำได้เมื่อจบการทำงานของฟังก์ชัน
<code>led_blink2(...)</code> และใช้ตัวแปรนี้ได้อีก เมื่อมีการเรียกฟังก์ชันในครั้งถัดไป</p>
<p>คำสั่ง <code>digitalWrite( pin, state ^= 1 );</code> จะทำให้ตัวแปร <code>state</code> เปลี่ยนค่าลอจิก (สลับค่าลอจิก
ระหว่าง <code>0</code> กับ <code>1</code>) แล้วนำค่าใหม่ของตัวแปรนี้ ไปใช้ในการเขียนค่าเอาต์พุตของขา <code>pin</code> ดังนั้นจะทำให้ <code>LED</code> เปลี่ยนสถานะลอจิก</p>
<pre><code class="language-c">#define LED_PIN   (LED_BUILTIN) // the default LED pin
#define DELAY_MS  (500)

void setup() {
  // Set the LED pin direction to output
  pinMode( LED_PIN, OUTPUT );
  // Output LOW to the LED pin
  digitalWrite( LED_PIN, LOW );
}

void loop() {
  led_blink2( LED_PIN );
}

void led_blink2( int pin ) {
  // Use a static local variable to keep the LED state 
  static uint8_t state = 0;
  // Toggle the LED pin
  digitalWrite( pin, state ^= 1 );
  // Delay for a few hundred milliseconds
  delay( DELAY_MS );
}
</code></pre>
<p>&nbsp;</p>
<hr />
<h2 id="3">&#9655; <strong>ตัวอย่างที่ 3</strong><a class="headerlink" href="#3" title="Permanent link">#</a></h2>
<p>ในโค้ดตัวอย่างนี้ มีการสร้างและเรียกใช้ฟังก์ชัน <code>led_blink3(...)</code> ที่มีความแตกต่างจากฟังก์ชันในตัวอย่างที่แล้ว</p>
<p>คำสั่ง <code>digitalWrite( pin, !digitalRead(pin) );</code> เป็นการอ่านค่าของ <code>pin</code> ในขณะนั้น
แล้วนำค่ามาสลับลอจิก (<strong>Bit Inverse</strong>) แล้วนำไปใช้ในการเขียนค่าเอาต์พุตของขา <code>pin</code> 
ดังนั้นจะทำให้ <code>LED</code> เปลี่ยนสถานะลอจิก</p>
<pre><code class="language-c">#define LED_PIN   (LED_BUILTIN) // the default LED pin
#define DELAY_MS  (500)

void setup() {
  // Set the LED pin direction to output
  pinMode( LED_PIN, OUTPUT );
  // Output LOW to the LED pin
  digitalWrite( LED_PIN, LOW );
}

void loop() {
  led_blink3( LED_PIN );
}

void led_blink3( int pin ) {
  // Toggle the LED pin
  digitalWrite( pin, !digitalRead(pin) );
  // Delay for a few hundred milliseconds
  delay( DELAY_MS );
}
</code></pre>
<p>&nbsp;</p>
<hr />
<h2 id="4">&#9655; <strong>ตัวอย่างที่ 4</strong><a class="headerlink" href="#4" title="Permanent link">#</a></h2>
<p>ในโค้ดตัวอย่างนี้ มีการสร้างและเรียกใช้ฟังก์ชัน <code>led_blink4(...)</code>
ที่มีความแตกต่างจากฟังก์ชันก่อนหน้านี้ โดยใช้วิธีการอ่านเวลาของระบบในขณะนั้น ด้วยคำสั่ง <code>millis()</code>
ซึ่งจะได้ค่าเป็นเลขจำนวนเต็มที่มีชนิดข้อมูลเป็น <code>uint32_t</code> และมีหน่วยเป็นมิลลิวินาที เก็บไว้ในตัวแปร <code>now</code> 
แล้วนำมาเปรียบเทียบกับค่าที่ได้เก็บบันทึกไว้ในอีกตัวแปรหนึ่งคือ <code>last_update_time</code>
ถ้าคำนวณผลต่างได้มากกว่าหรือเท่ากับ <code>DELAY_MS</code> ก็ให้สลับสถานะลอจิกของเอาต์พุต <code>pin</code>
โดยเรียกฟังก์ชัน <code>led_toggle(...)</code> แล้วอัปเดตค่าของตัวแปร <code>last_update_time</code>
ให้เท่ากับค่าของตัวแปร <code>now</code></p>
<pre><code class="language-c">#define LED_PIN   (LED_BUILTIN) // the default LED pin
#define DELAY_MS  (500)

void setup() {
  // Set the LED pin direction to output
  pinMode( LED_PIN, OUTPUT );
  // Output LOW to the LED pin
  digitalWrite( LED_PIN, LOW );
}

void loop() {
  led_blink4( LED_PIN );
}

void led_toggle( int pin=LED_PIN ) {
  // Toggle the specified pin
  digitalWrite( pin, !digitalRead(pin) );
}

void led_blink4( int pin ) {
  static uint32_t last_update_time = 0;
  uint32_t now = millis();
  if ( now - last_update_time &gt;= DELAY_MS ) {
    // Save the last update time
    last_update_time = now;
    // Toggle the LED pin
    led_toggle( pin );
  }
}
</code></pre>
<p>&nbsp;</p>
<hr />
<h2 id="5">&#9655; <strong>ตัวอย่างที่ 5</strong><a class="headerlink" href="#5" title="Permanent link">#</a></h2>
<p>โค้ดตัวอย่างนี้สาธิตการเปิดใช้งานวงจร <strong>Timer1</strong> ของชิปไมโครคอนโทรลเลอร์ <strong>ATmega328P</strong>
มีการสร้างและเรียกใช้ฟังก์ชัน <code>void init_timer1()</code> เพื่อตั้งค่าการทำงานของวงจร <strong>Timer1</strong>
(มีขนาดของตัวนับเท่ากับ 16 บิต) เช่น การตั้งค่าตัวหารความถี่ เพื่อทำให้วงจรนับทำงานด้วยมีความถี่ลดลงจาก <strong>16MHz</strong> 
ให้เท่ากับ <strong>2Hz</strong> หรือ มีคาบเท่ากับ 500 มิลลิวินาที</p>
<p>นอกจากนั้นแล้ว ยังมีการเปิดใช้งานอินเทอร์รัพท์ที่เกี่ยวข้องกับ <strong>Timer1</strong> เมื่อนับครบหนึ่งรอบ 
โดยนับจาก <code>0</code> ถึง <code>(31250-1)</code> แล้วเริ่มต้นนับใหม่ ฟังก์ชันที่เกี่ยวข้องกับอินเทอร์รัพท์  (หรือ <strong>ISR</strong>) ของตัวนับนี้คือ <code>ISR(TIMER1_COMPA_vect)</code>
ซึ่งจะทำหน้าที่เพิ่มค่าของตัวแปร <code>counter</code> ขึ้นครั้งละหนึ่ง</p>
<p>ในฟังก์ชัน <code>led_blink5(...)</code> จะมีการเรียกฟังก์ชัน <code>init_timer1()</code> เพียงครั้งเดียว
และในการทำงานของฟังก์ชันเมื่อถูกเรียก จะมีการตรวจสอบดูว่า ค่าของตัวแปร <code>counter</code> มีการเปลี่ยนแปลงหรือไม่
โดยเปรียบเทียบกับค่าของตัวแปร <code>last_counter</code> ที่บันทึกค่าเพื่อการเปรียบเทียบ ถ้ามีการเปลี่ยนแปลง (ค่าของตัวแปร
<code>last_counter</code> ไม่เท่ากับ <code>counter</code>) ก็ให้สลับสถานะลอจิกของเอาต์พุต <code>pin</code>
แล้วอัปเดตค่าของตัวแปร <code>last_counter</code> ให้เท่ากับค่า <code>counter</code></p>
<pre><code class="language-c">#define LED_PIN   (LED_BUILTIN) // the default LED pin

void setup() {
  // Set LED pin direction to output
  pinMode( LED_PIN, OUTPUT );
  // Output LOW to the LED pin
  digitalWrite( LED_PIN, LOW );
}

void loop() {
  led_blink5( LED_PIN );
}

void led_toggle( int pin=LED_PIN ) {
  // Toggle the specified pin
  digitalWrite( pin, !digitalRead(pin) );
}

// This global variable is used by ISR.
volatile uint32_t counter = 0;

void led_blink5( int pin ) {
  static uint8_t timer1_initialized = 0;
  static uint32_t last_counter = 0;
  if ( timer1_initialized == 0 ) { // For the first function call
    // Mark timer1 as initialized
    timer1_initialized = 1;
    // Initialize Timer1
    init_timer1();
  }
  else if ( last_counter != counter ) {
    // Save the last counter value
    last_counter = counter;
    // Toggle the LED pin
    led_toggle( pin );
  }
}

void init_timer1() {
  // Set Timer1 to CTC (Clear Timer on Compare) mode
  TCCR1A = 0;
  TCCR1B = (1 &lt;&lt; WGM12);
  // Set the timer compare value to generate an interrupt every 500 msec
  OCR1A  = (31250-1); // (16MHz /256 /2) - 1
  // Enable Timer1 compare interrupt
  TIMSK1 = (1 &lt;&lt; OCIE1A);  
  // Set Timer1 prescaler to 256 and start the timer
  TCCR1B |= (1 &lt;&lt; CS12);
  // Enable interrupts
  sei();
}

ISR(TIMER1_COMPA_vect) {
  counter++;
}
</code></pre>
<p>&nbsp;</p>
<hr />
<h2 id="6">&#9655; <strong>ตัวอย่างที่ 6</strong><a class="headerlink" href="#6" title="Permanent link">#</a></h2>
<p>โค้ดตัวอย่างนี้สาธิตการใช้ไลบรารีสำหรับ <strong>Arduino</strong> ที่มีชื่อว่า
<a href="https://www.arduino.cc/reference/en/libraries/timerone/"><code>TimerOne</code></a>
โดยจะต้องตั้งค่าสำหรับช่วงเวลาในการทำงาน และฟังก์ชัน <strong>Callback</strong> ที่จะถูกเรียกให้ทำงานเมื่อเกิดเหตุการณ์ดังกล่าว</p>
<ul>
<li><code>Timer1.initialize( 500000 );</code>
เป็นการตั้งค่าเวลา (ช่วงเวลาหรือคาบเวลา) ให้ทำงานทุก ๆ 500000 ไมโครวินาที หรือ 500 มิลลิวินาที</li>
<li><code>Timer1.attachInterrupt( led_toggle );</code> เป็นการระบุว่า ให้ใช้ฟังก์ชัน 
<code>led_toggle</code> เป็นฟังก์ชันสำหรับ <strong>Callback</strong> ที่จะทำงานตามคาบเวลาที่กำหนดไว้</li>
</ul>
<pre><code class="language-c">#include &lt;TimerOne.h&gt; // if the TimerOne library is used.

#define LED_PIN   (LED_BUILTIN) // the default LED pin

void setup() {
  // Set LED pin direction to output
  pinMode( LED_PIN, OUTPUT );
  // Output LOW to the LED pin
  digitalWrite( LED_PIN, LOW );
}

void loop() {
  led_blink6( LED_PIN );
}

void led_toggle() {
  // Toggle the specified pin
  digitalWrite( LED_PIN, !digitalRead(LED_PIN) );
}

void led_blink6( int pin ) {
  static uint8_t timer1_initialized = 0;
  if ( timer1_initialized == 0 ) { // For the first function call
    // Mark timer1 as initialized
    timer1_initialized = 1;
    // Set period in microseconds
    Timer1.initialize( 500000 ); 
    // Attach a callback function
    Timer1.attachInterrupt( led_toggle );
  }
}
</code></pre>
<p>&nbsp;</p>
<hr />
<h2 id="7">&#9655; <strong>ตัวอย่างที่ 7</strong><a class="headerlink" href="#7" title="Permanent link">#</a></h2>
<p>โค้ดตัวอย่างนี้สาธิตการเปิดใช้งานวงจร <strong>WDT (Watchdog Timer)</strong> ของ <strong>ATmega328P</strong>
ซึ่งเป็นวงจรตัวนับ และมีการสร้างและเรียกใช้ฟังก์ชัน <code>init_wdt(...)</code>
เพื่อตั้งค่าให้นับแล้วทำให้เกิดอินเทอร์รัพท์ ทุก 500 มิลลิวินาที (โดยประมาณ)  และมีฟังก์ชัน <code>ISR(WDT_vect)</code>
ที่จะทำงานโดยอัตโนมัติ เมื่อเกิดอินเทอร์รัพท์ในแต่ละครั้ง ซึ่งจะเพิ่มค่าของตัวแปร <code>counter</code> ครั้งละหนึ่ง</p>
<p>ในฟังก์ชัน <code>led_blink7(...)</code> จะมีการเปรียบเทียบระหว่างค่าของตัวแปร
<code>last_counter</code> และ <code>counter</code> ถ้ามีค่าไม่เท่ากัน ให้สลับค่าลอจิกของขาเอาต์พุต <code>pin</code>
แล้วอัปเดตค่าของตัวแปร <code>last_counter</code> ให้เท่ากับค่า <code>counter</code></p>
<pre><code class="language-c">#include &lt;avr/wdt.h&gt;  // if WDT is used.

#define LED_PIN   (LED_BUILTIN) // the default LED pin

// This global variable is used by ISR.
volatile uint32_t counter = 0;

void setup() {
  // Set LED pin direction to output
  pinMode( LED_PIN, OUTPUT );
  // Output LOW to the LED pin
  digitalWrite( LED_PIN, LOW );
}

void loop() {
  led_blink7( LED_PIN );
}

void led_toggle( int pin=LED_PIN ) {
  // Toggle the specified pin
  digitalWrite( pin, !digitalRead(pin) );
}

void led_blink7( int pin ) {
  static uint8_t wdt_initialized = 0;
  static uint32_t last_counter = 0;
  if ( wdt_initialized == 0 ) {
    // Mark WDT as initialized
    wdt_initialized = 1;
    // Initialize WDT
    init_wdt();
  }
  else if ( last_counter != counter ) {
    // Save the last counter value
    last_counter = counter;
    // Toggle the LED pin
    led_toggle( pin );
  }
}

void init_wdt() {
  // Make sure the WDT is disabled before changing the settings
  wdt_reset(); 
  // Set up WDT with 500ms timeout (approximately).
  wdt_enable(WDTO_500MS);
  // Enable WDT interrupt.
  WDTCSR |= (1&lt;&lt;WDIE);
  // Reset the WDT
  wdt_reset(); 
  // Enable interrupts
  sei(); 
}

ISR(WDT_vect) {
  counter++;
}
</code></pre>
<p><img alt="" src="wdt_waveform.png" /></p>
<p>รูป: การวัดสัญญาณเอาต์พุตด้วยออสซิลโลสโคป (<strong>RIGOL DS1054Z</strong>) ที่ได้จากการทำงานของโค้ดตัวอย่างที่ 7</p>
<p>&nbsp;</p>
<hr />
<h2 id="8">&#9655; <strong>ตัวอย่างที่ 8</strong><a class="headerlink" href="#8" title="Permanent link">#</a></h2>
<p>โค้ดตัวอย่างนี้สาธิตการใช้งานวงจร <strong>Timer1</strong> ในโหมดการสร้างสัญญาณ <strong>Fast PWM (Pulse Width Modulation)</strong>
โดยตั้งค่าตัวหารความถี่ (<strong>Prescaler</strong>) ให้เท่ากับ <strong>256</strong> และกำหนดค่าในรีจิสเตอร์ <code>ICR1</code> มีค่าสูงสุดเป็น <code>(62500-1)</code>  หรือคาบของการนับขึ้น
ตัวเลข <code>62500</code>  คำนวณได้จากความถี่ของซีพียู (<strong>16MHz</strong>) หารด้วย <code>256</code></p>
<p>ค่าในรีจิสเตอร์ <code>OCR1A</code> จะต้องถูกกำหนดให้เป็นครึ่งหนึ่งของค่าในรีจิสเตอร์ <code>ICR1</code> เพื่อทำให้ได้สัญญาณ <strong>PWM</strong>
ที่มีค่า <strong>Duty Cycle</strong> เท่ากับ <strong>50%</strong></p>
<p>ข้อสังเกต: สัญญาณเอาต์พุต <strong>PWM</strong> ที่ได้จากการทำงานของ <strong>Timer1</strong> ในตัวอย่างนี้ ตรงกับขา <strong>Arduino D9 Pin</strong></p>
<pre><code class="language-c">#define LED_PIN   (9)

void setup() {
  // Set the output pin for PWM
  pinMode(LED_PIN, OUTPUT);
  // Initialize Timer1 for PWM output on D9 pin
  init_timer1_pwm();
}

void loop() {
  // empty
}

void init_timer1_pwm() {
  // Set prescaler to 256.
  // Use fast-PWM, non-inverting mode 14: WGM1[3:0]=&quot;1110&quot;.
  // Set OC1A pin at BOTTOM (0x0000). 
  // Clear OC1A pin on Compare Match.
  TCCR1A = (1 &lt;&lt; COM1A1) | (1 &lt;&lt; WGM11);
  TCCR1B = (1 &lt;&lt; WGM13)  | (1 &lt;&lt; WGM12) | (1 &lt;&lt; CS12);
  // Set top value: 16MHz/(256)/1Hz = 62500.
  ICR1 = 62500-1; 
  // Use 50% duty cycle
  OCR1A = ICR1 / 2;
}
</code></pre>
<p><img alt="" src="timer1_pwm_waveform.png" /></p>
<p>รูป: การวัดสัญญาณเอาต์พุตด้วยออสซิลโลสโคป (<strong>RIGOL DS1054Z</strong>) ที่ได้จากการทำงานของโค้ดตัวอย่างที่ 8</p>
<p>&nbsp;</p>
<hr />
<h2 id="9">&#9655; <strong>ตัวอย่างที่ 9</strong><a class="headerlink" href="#9" title="Permanent link">#</a></h2>
<p>ในตัวอย่างนี้ มีการสาธิตการใช้ไลบรารี <a href="https://github.com/feilipu/Arduino_FreeRTOS_Library"><strong>"Arduino FreeRTOS"</strong></a> (<code>Arduino_FreeRTOS.h</code>)
สำหรับ <strong>Arduino Uno / Nano / MEGA</strong>
และสร้างทาสก์ (<strong>FreeRTOS Task</strong>) โดยใช้คำสั่ง <a href="https://www.freertos.org/a00125.html"><code>xTaskCreate(...)</code></a>
และมีการสร้างฟังก์ชัน <code>led_toggle_task(...)</code> สำหรับทาสก์ดังกล่าว เพื่อให้ทำหน้าที่สลับสถานะลอจิกของขาเอาต์พุตด้วยอัตราคงที่ (ประมาณ <strong>512</strong> มิลลิวินาที)</p>
<p>นอกจากนั้นแล้วยังมีการสาธิตการสร้างคลาสที่มีชื่อว่า <code>LED</code> ในภาษา <strong>C++</strong> 
เพื่อใช้ในการกำหนดหรือเปลี่ยนสถานะลอจิกของขาเอาต์พุตสำหรับ <strong>LED</strong>  </p>
<pre><code class="language-c++">
#include &lt;Arduino_FreeRTOS.h&gt; // if the Arduino FreeRTOS library is used.

#define LED_PIN   (LED_BUILTIN)
#define DELAY_MS  (500)

// Define a LED class with inline member functions
class LED {
  public:
    LED(int pin, int state=0) : _pin(pin), _state(state) { // Constructor
      pinMode( _pin, OUTPUT );
      digitalWrite( _pin, _state ); 
    }
    int toggle() { // Toggle the state of the LED pin
      digitalWrite(_pin, _state^=1 ); 
      return _state;
    }
    LED&amp; operator=(bool value) { // Implemen an assignment operator
      _state = value;
      digitalWrite(_pin, _state);
      return *this;
    }
    operator bool() const { // Return the current state of the LED pin
      return _state;
    }
  private: 
    int _pin;   // Used to keed Arduino pin number for the LED pin
    int _state; // Used to keep the current LED state
};

// Create an LED object
LED led(LED_PIN);

void led_toggle_task(void *pvParameters) {
  LED _led = *((LED *)pvParameters);
  while (1) {
    // Toggle the LED state
    //_led.toggle(); // Method 1
    _led = !_led;   // Method 2
    // Delay for a few OS ticks
    vTaskDelay( DELAY_MS / portTICK_PERIOD_MS );
  }
}

void setup( ) {
  // Create a FreeRTOS task which is used to toggle the LED pin
  xTaskCreate(led_toggle_task,  /* task function */
              &quot;task&quot;,           /* task name */
              96,               /* task stack size */
              (void*)&amp;led,      /* task function's parameter */
              1,                /* task priority */
              NULL              /* task handle */ 
  ); 
}

void loop() {  
  // empty or yield() 
  yield();
}
</code></pre>
<p>&nbsp;</p>
<hr />
<h2 id="_1">&#9655; <strong>กล่าวสรุป</strong><a class="headerlink" href="#_1" title="Permanent link">#</a></h2>
<p>บทความนี้นำเสนอตัวอย่างการเขียนโค้ด <strong>Arduino Sketch</strong> ในรูปแบบที่แตกต่างกันเพื่อทำให้ขาเอาต์พุต
สำหรับ <strong>LED</strong> เปลี่ยนสถานะลอจิก ทำให้ <strong>LED</strong> กระพริบได้ และจะเห็นได้ว่า บางวิธีก็จะเจาะจงใช้วงจรภายในของชิป
ไมโครคอนโทรลเลอร์ <strong>ATmega328P</strong> เช่น วงจรตัวนับ <strong>Timer1</strong> และ <strong>WDT</strong> เป็นต้น</p>
<p>&nbsp;</p>
<hr />
<p><em>This work is licensed under a</em> <strong><em>Creative Commons Attribution-ShareAlike 4.0 International License</em></strong>.</p>
<p>Created: 2023-03-30 | Last Updated: 2023-04-01</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2021-2024 IoT Engineering Education, Bangkok/Thailand</a></p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
