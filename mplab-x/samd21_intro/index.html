<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="RSP">
        <link rel="canonical" href="http://iot-kmutnb.github.com/blogs/mplab-x/samd21_intro/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>ATSAMD21 Programming with MPLAB-X IDE and Harmony v3 Framework - IoT Engineering Education</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/font-awesome.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/styles/github.min.css">
        <link href="../../css/extra.css" rel="stylesheet">

        <script src="../../js/jquery-1.10.2.min.js" defer></script>
        <script src="../../js/bootstrap.min.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/typescript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/json.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/vhdl.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/verilog.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/arduino.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/c.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/cpp.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.5.0/languages/bash.min.js"></script>
        <script>hljs.initHighlightingOnLoad();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">IoT Engineering Education</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar-collapse">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="navitem">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="navitem">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ml-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-toggle="modal" data-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-light navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-toggle="collapse" data-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-secondary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-level="1"><a href="#atsamd21-programming-with-mplab-x-ide-and-harmony-v3-framework" class="nav-link">ATSAMD21 Programming with MPLAB-X IDE and Harmony v3 Framework</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-level="2"><a href="#mplab-harmony-plugin" class="nav-link">&#9655; การติดตั้ง MPLAB Harmony Plugin</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#mplab-harmony-software-packages" class="nav-link">&#9655; การติดตั้ง MPLAB Harmony Software Packages</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_1" class="nav-link">&#9655; การสร้างโปรเจกต์ใหม่</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#bare-metal-c" class="nav-link">&#9655; การเขียนโค้ดแบบ Bare-Metal C</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#systick-arm-cortex-m0" class="nav-link">&#9655; การเปิดใช้งานวงจร SysTick ของ Arm Cortex-M0+</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#bin-hex" class="nav-link">&#9655; การสร้างไฟล์ .bin จาก .hex</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#bootloader" class="nav-link">&#9655; การคอมไพล์โค้ดเพื่อใช้งานร่วมกับ Bootloader</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_2" class="nav-link">&#9655; แหล่งข้อมูลศึกษาเพิ่มเติม</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-level="2"><a href="#_3" class="nav-link">&#9655; กล่าวสรุป</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="atsamd21-programming-with-mplab-x-ide-and-harmony-v3-framework">ATSAMD21 Programming with MPLAB-X IDE and Harmony v3 Framework<a class="headerlink" href="#atsamd21-programming-with-mplab-x-ide-and-harmony-v3-framework" title="Permanent link">#</a></h1>
<p>บทความนี้นำเสนอขั้นตอนการติดตั้ง <a href="https://microchip-mplab-harmony.github.io/quick_docs/source/basic/mplab_harmony_3_configurator/readme.html"><strong>Microchip Harmony V3 Plugin</strong></a> สำหรับ <a href="https://www.microchip.com/en-us/tools-resources/develop/mplab-x-ide"><strong>MPLAB-X IDE</strong></a> (ทดลองใช้เวอร์ชัน <strong>v6.00</strong> สำหรับ <strong>Windows</strong>) และการติดตั้งซอฟต์แวร์ต่าง ๆ ที่เกี่ยวข้อง เพื่อทดลองเขียนโปรแกรมสำหรับบอร์ดไมโครคอนโทรลเลอร์ <strong>ATSAMD21</strong> (<strong>ARM Cortex-M0+</strong>) โดยใช้ <strong>Harmony Framework v3</strong> และ <strong>XC32 Compiler</strong></p>
<p><strong>Keywords:</strong> <em>MPLAB-X IDE</em>, <em>Harmony v3 Framework</em>, <em>ATSAMD21</em></p>
<hr />
<h2 id="mplab-harmony-plugin">&#9655; <strong>การติดตั้ง MPLAB Harmony Plugin</strong><a class="headerlink" href="#mplab-harmony-plugin" title="Permanent link">#</a></h2>
<p>ในอดีตหากต้องการเขียนโปรแกรมภาษา <strong>C/C++</strong> สำหรับไมโครคอนโทรลเลอร์ขนาด 32 บิต ตระกูล <strong>SAM</strong> เช่น <strong>ATSAMD21</strong>
เราก็อาจเลือกใช้ซอฟต์แวร์ของบริษัท <strong>Atmel</strong> ต่อไปนี้ และสามารถใช้งานร่วมกันได้</p>
<ul>
<li><a href="https://www.microchip.com/en-us/tools-resources/develop/microchip-studio"><strong>Atmel Studio 7 / Microchip Studio</strong></a> ทำหน้าที่เป็น <strong>IDE</strong> แต่ใช้ได้สำหรับระบบปฏิบัติการ <strong>Windows</strong> เท่านั้น</li>
<li><a href="https://www.microchip.com/en-us/tools-resources/develop/libraries/advanced-software-framework"><strong>Atmel Advanced Software Framework 4 (ASF4) for SAM devices</strong></a> ทำหน้าที่ <strong>API</strong> ระดับสูงสำหรับการเขียนโค้ด <strong>C/C++</strong> ประกอบไปด้วยแพ็กเกจของซอฟต์แวร์ และไลบรารีต่าง ๆ </li>
<li><a href="https://microchipdeveloper.com/atstart:start"><strong>Atmel START</strong></a> ทำหน้าที่เป็น <strong>Web-based Device &amp; Software Content Configurator</strong> เพื่อช่วยในการตั้งค่าการใช้งานฮาร์ดแวร์ (<strong>Device Configuration</strong>) และสร้างโค้ดได้โดยอัตโนมัติ (<strong>Code Generation</strong>) และนำไปใช้กับ <strong>IDE</strong> ได้แก่ <strong>Atmel Studio 7</strong>, <strong>Keil uVision</strong>, <strong>IAR Embedded Workbench</strong></li>
</ul>
<p>แต่ถ้าเป็นบอร์ด <strong>Arduino</strong> ที่ใช้ชิปไมโครคอนโทรลเลอร์ดังกล่าว เช่น <a href="https://docs.arduino.cc/hardware/zero/"><strong>Arduino Zero</strong></a> หรือ <a href="https://store-usa.arduino.cc/collections/mkr-family"><strong>Arduino MKR</strong></a>
ก็สามารถใช้ <strong>Arduino IDE</strong> ในการเขียนโปรแกรมได้ แต่ก็จำกัดอยู่แค่ <strong>ATSAMD21</strong> เท่านั้น ไม่สามารถใช้กับบอร์ดที่มีชิปไมโครคอนโทรลเลอร์ตระกูล <strong>SAM</strong> ที่แตกต่างออกไปได้ (เช่น <strong>SAM-L, SAM-C, SAM-xE</strong> เป็นต้น)</p>
<p>ในปัจจุบัน บริษัท <strong>Microchip</strong> ได้รองรับการใช้งานชิปไมโครคอนโทรลเลอร์ของตระกูล <strong>SAM</strong> ให้สามารถใช้งานร่วมกับซอฟต์แวร์ของทางบริษัทได้แก่</p>
<ul>
<li><a href="https://www.microchip.com/en-us/tools-resources/develop/mplab-x-ide"><strong>MPLAB-X IDE</strong></a> ทำหน้าที่เป็น <strong>IDE</strong> แทนที่การใช้งาน <strong>Atmel Studio 7</strong></li>
<li><a href="https://github.com/Microchip-MPLAB-Harmony/Microchip-MPLAB-Harmony.github.io/wiki"><strong>MPLAB Harmony 3</strong></a> แทนที่การใช้งาน <strong>Atmel ASF4</strong></li>
<li><a href="https://microchip-mplab-harmony.github.io/quick_docs/source/basic/mplab_harmony_3_configurator/readme.html"><strong>MPLAB Harmony 3 Configurator</strong></a> แทนที่การใช้งาน <strong>Atmel START</strong></li>
</ul>
<p><a href="https://www.microchip.com/en-us/tools-resources/configure/mplab-harmony"><strong>MPLAB Harmony Framework</strong></a> เป็นซอฟต์แวร์ประเภท <strong>Open Source</strong> (<a href="https://github.com/Microchip-MPLAB-Harmony"><strong>Github repo</strong></a>) ที่ใช้ในการพัฒนาเฟิร์มแวร์ (<strong>Embedded Software Development Framework</strong>) ด้วยภาษา <strong>C/C++</strong>
สำหรับไมโครคอนโทรลเลอร์ 32 บิต ของบริษัท <strong>Microchip</strong> ซึ่งได้แก่ ตระกูล <strong>PIC32</strong> 
และ <strong>SAM (Arm Cortex-M Series)</strong></p>
<p><img alt="" src="../images/mplab_harmony.png" /></p>
<p>รูป:  <strong>MPLAB Harmony Framework</strong> (Source: Microchip)</p>
<p><img alt="" src="../images/harmony_v3_layers.png" /></p>
<p>รูป: <strong>MPLAB Harmony 3 Software Packages</strong> (Source: Microchip)</p>
<p><img alt="" src="../images/harmony_v3_configurator.png" />
รูป: <strong>MPLAB Harmony 3 Device &amp; Software Configurator</strong>  (Source: Microchip)</p>
<p>ผู้ใช้จะต้องติดตั้งซอฟต์แวร์ <strong>MPLAB-X IDE</strong> ไว้ในเครื่องคอมพิวเตอร์พร้อมแล้ว
เมื่อเปิดใช้งาน ให้ไปที่เมนูคำสั่ง <strong>Tools &gt; Plugins</strong> เพื่อติดตั้งซอฟต์แวร์ดังนี้</p>
<ul>
<li><strong>MPLAB Harmony Configurator (<a href="https://www.microchip.com/en-us/tools-resources/configure/mplab-harmony/configurator">MHC</a>)</strong> ทำหน้าที่เป็น  <strong>GUI-based configurator</strong>
ช่วยให้ผู้ใช้สามารถตั้งค่าการใช้งานชิปไมโครคอนโทรลเลอร์เป้าหมาย สร้างโค้ดที่เกี่ยวข้อง รวมถึงการนำเข้าไลบรารีต่าง ๆ ในโปรเจกต์</li>
<li><strong>MPLAB Harmony 3 Launcher</strong> สำหรับเรียกใช้งาน <strong>MHC</strong> จาก <strong>MPLAB-X IDE</strong></li>
</ul>
<p>ในหน้าต่าง <strong>Plugins</strong> ให้ตรวจสอบดูรายการ <strong>Available Plugins</strong> แล้วเลือกติดตั้ง <strong>MPLAB Harmony Configurator</strong> และ <strong>MPLAB Harmony 3 Launcher</strong> ตามลำดับ</p>
<p><img alt="" src="../images/harmony_v3_plugin-1.png" /></p>
<p>รูป: การติดตั้ง <strong>MPLAB Harmony Configurator</strong></p>
<p><img alt="" src="../images/harmony_v3_plugin-2.png" /></p>
<p>รูป: การติดตั้ง <strong>MPLAB Harmony 3 Launcher</strong></p>
<p><img alt="" src="../images/harmony_v3_plugin-3.png" /></p>
<p>รูป: ตรวจสอบรายการ <strong>Plugins</strong> ที่ได้มีการติดตั้งในระบบได้แล้ว</p>
<p>&nbsp;</p>
<hr />
<h2 id="mplab-harmony-software-packages">&#9655; <strong>การติดตั้ง MPLAB Harmony Software Packages</strong><a class="headerlink" href="#mplab-harmony-software-packages" title="Permanent link">#</a></h2>
<p>ไปที่เมนู <strong>Tools &gt; Embedded &gt; MPLAB Harmony Content Manager</strong></p>
<p><img alt="" src="../images/harmony_v3_content_manager-1.png" /></p>
<p>รูป:  เรียกใช้งาน <strong>MPLAB Harmony Content Manager</strong></p>
<p><img alt="" src="../images/harmony_v3_content_manager-2.png" /></p>
<p>รูป: แสดงรายการ (บางส่วน) แบ่งเป็นแพ็กเกจ (<strong>Remote Packages</strong>) ที่สามารถดาวน์โหลดจาก <strong>Github</strong> เพื่อนำมาติดตั้งและใช้งาน</p>
<p><img alt="" src="../images/harmony_v3_content_manager-3.png" /></p>
<p>รูป: หากต้องการติดตั้ง <code>core</code> จะต้องมีการติดตั้งแพ็กเกจอื่นที่เกี่ยวข้องด้วย </p>
<p>ตัวอย่างรายการสำหรับการติดตั้งแพ็กเกจ มีดังนี้ และให้สังเกตว่า
การเลือกเวอร์ชันของซอฟต์แวร์เหล่านี้ จะต้องสัมพันธ์กันตามหมายเลขเวอร์ชัน (<strong>Software Dependencies</strong>) เช่น</p>
<ul>
<li><code>mhc</code> (v3.8.2)</li>
<li><code>dev_packs</code> (v3.10.0)</li>
<li><code>csp</code>  (v3.10.0)</li>
<li><code>bsp</code>  (v3.10.0)</li>
<li><code>core</code> (v3.10.0)</li>
<li><code>littlefs</code> (v2.4.1)</li>
<li><code>usb</code>  (v3.8.1)</li>
<li><code>CMSIS-FreeRTOS</code> (v10.3.1)</li>
</ul>
<p>รายการแพ็กเกจที่ได้มีการติดตั้งแล้ว ผู้ใช้สามารถตรวจสอบดูได้จากรายการ <strong>Local Packages</strong></p>
<p>หากต้องการเปิดใช้งาน <strong>MPLAB Harmony Configurator (MHC)</strong> 
จะต้องสร้างโปรเจกต์ใหม่ใน <strong>MPLAB-X IDE</strong> ก่อน </p>
<p>ถ้ายังไม่ได้ติดตั้งซอฟต์แวร์ <a href="https://www.microchip.com/en-us/tools-resources/develop/mplab-xc-compiler"><strong>Microchip XC32 Compiler</strong></a> ในเครื่องของผู้ใช้ ให้ดำเนินการติดตั้งก่อนทำขั้นตอนถัดไป</p>
<p>&nbsp;</p>
<hr />
<h2 id="_1">&#9655; <strong>การสร้างโปรเจกต์ใหม่</strong><a class="headerlink" href="#_1" title="Permanent link">#</a></h2>
<p>ขั้นตอนมีดังนี้</p>
<p><strong>1)</strong> ไปยังเมนู <strong>File &gt; New Project...</strong> แล้วเลือก "<strong>Categories: Microchip Embedded</strong>"
และ "<strong>Projects: 32-bit MPLAB Harmony 3 Project</strong>" แล้วกดปุ่ม <strong>Next</strong></p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-1.png" /></p>
<p>รูป: เริ่มต้นขั้นตอนการสร้างโปรเจกต์ใหม่</p>
<p><strong>2)</strong> กดปุ่ม <strong>Launch Content Manager</strong> แล้วกดปุ่ม <strong>Next</strong></p>
<p>ในตัวอย่างนี้ ได้มีการติดตั้ง <strong>MPLAB Harmony 3 Packages</strong> ไว้ในไดเรกทอรี
<code>C:\Work\Harmony3</code> ดังนั้นจะต้องเลือก <strong>Framework Path</strong>
ให้ถูกต้องตามที่มีอยู่จริงในคอมพิวเตอร์ของผู้ใช้ </p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-2.png" /></p>
<p>รูป: เปิดใช้งาน <strong>Launch Content Manager</strong></p>
<p><strong>3)</strong> ตั้งชื่อโปรเจกต์ใหม่ และไดเรกทอรีสำหรับโปรเจกต์</p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-3.png" /></p>
<p>รูป: ตัวอย่างการตั้งชื่อและสร้างไดเรกทอรีใหม่สำหรับโปรเจกต์</p>
<p><strong>4)</strong> เลือกชิปไมโครคอนโทรลเลอร์ ในตัวอย่างนี้คือ "<strong>Device Family: ATSAM</strong>" และ 
"<strong>Target Device: ATSAMD21G18A</strong>" (<strong>ARM Cortex-M0+, 256KB Flash, 32KB SRAM, 48MHz</strong>)</p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-4.png" /></p>
<p>รูป:  เลือกชิปไมโครคอนโทรลเลอร์ที่จะใช้งานในโปรเจกต์</p>
<p><strong>5)</strong> เข้าสู่ขั้นตอนการตั้งค่าฮาร์ดแวร์และซอฟต์แวร์สำหรับโปรเจกต์โดยใช้  <strong>MHC</strong>
จากนั้นจะปรากฎหน้าต่าง "<strong>Configuration Database Setup</strong>" ให้กดปุ่ม <strong>Launch</strong></p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-5.png" /></p>
<p>รูป: <strong>Configuration Database Setup</strong></p>
<p>จากรูปจะเห็นได้ว่า มีส่วนที่เกี่ยวข้องกับการตั้งค่าใช้งานสำหรับซอฟต์แวร์ <strong>CMSIS Pack</strong> 
และ <strong>Device Family Pack (DFP)</strong> ของ <strong>Device Packs</strong>
และวงจรภายในชิป เช่น  <strong>NVMCTRL</strong>, <strong>EVSYS</strong>, <strong>System</strong></p>
<p>ในเบื้องต้นยังไม่ต้องแก้ไขการตั้งค่าใด ๆ และให้ทำคำสั่ง 
<strong>MHC &gt; Generate Code</strong> เพื่อสร้างไฟล์ที่จำเป็นและนำเข้าสู่โปรเจกต์ใหม่ เช่น
ไฟล์ <strong>Linker Script (.ld)</strong> สำหรับ <strong>XC32 Compiler</strong> 
และ <strong>Startup File</strong> เป็นต้น</p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-6.png" /></p>
<p>รูป: แสดงเมนูคำสั่งย่อยที่เกี่ยวข้องกับ <strong>MHC</strong></p>
<p><strong>6)</strong> เปิดไฟล์ <code>main.c</code> ในโปรเจกต์ แล้วแก้ไขตามโค้ดตัวอย่าง และคอมไพล์โค้ดเพื่อตรวจสอบความถูกต้อง</p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-7.png" /></p>
<p>รูป: การเปิดไฟล์ <code>main.c</code> และเขียนโค้ดตามตัวอย่าง</p>
<p>&nbsp;</p>
<p><strong>File:</strong> <code>main.c</code></p>
<pre><code class="language-c++">#include &lt;stddef.h&gt;           // Defines NULL
#include &lt;stdbool.h&gt;          // Defines true
#include &lt;stdlib.h&gt;           // Defines EXIT_FAILURE
#include &quot;definitions.h&quot;      // SYS function prototypes

int main( void ) {
    /* Initialize all modules */
    // SYS_Initialize ( NULL );
    SYSCTRL_REGS-&gt;SYSCTRL_OSC8M &amp;= ~SYSCTRL_OSC8M_PRESC_Msk; // 8MHz
    PORT_PinOutputEnable( PORT_PIN_PA27 );
    PORT_PinClear( PORT_PIN_PA27 );

    while ( true ) {
       PORT_PinToggle( PORT_PIN_PA27 );
       for ( uint32_t i=0; i &lt; 1000000; i++ ) { // busy-wait
           asm volatile( &quot;nop\n&quot; ); 
       }
    }
    return ( EXIT_FAILURE );
}
</code></pre>
<p>โค้ดตัวอย่างแรกนี้ เป็นการสาธิตการเขียนโค้ดเพื่อทำให้ขา <strong>PA27</strong> เปลี่ยนสถานะลอจิก และมีการเว้นระยะเวลา
ก่อนทำคำสั่งครั้งถัดไป (โดยใช้วิธี <strong>Software Delay Loop</strong>)</p>
<p>ในการทำงานของซีพียูและวงจรภายในชิป <strong>ATSAMD21</strong> ในตัวอย่างนี้ เราจะใช้สัญญาณ <strong>Clock</strong>
จากวงจรสร้างสัญญาณภายใน (<strong>On-chip Oscillator</strong>) ที่มีความถี่ 8 MHz (และตั้งค่าตัวหารความถี่เป็น /1)</p>
<p><strong>7)</strong>  ตั้งค่าความถี่ในการทำคำสั่งของซีพียูสำหรับตัวจำลองการทำงาน <strong>Simulator</strong> </p>
<p>ถ้ายังไม่มีบอร์ดไมโครคอนโทรลเลอร์ และต้องการตรวจสอบการทำงานของโค้ดตัวอย่าง ก็ให้ใช้งาน <strong>Simulator</strong>
ของ <strong>MPLAB-X IDE</strong></p>
<p>ให้ไปที่ <strong>File &gt; Project Properties</strong>
แล้วให้แก้ไขการตั้งค่าในส่วนที่เกี่ยวกับ <strong>Conf: [default] &gt; Simulator &gt; Options for Oscillator</strong> 
ให้ตั้งค่าตามรูปตัวอย่าง แล้วกดปุ่ม <strong>Apply / OK</strong> </p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-8.png" /></p>
<p>รูป: การตั้งค่าความถี่ของซีพียูสำหรับการจำลองการทำงาน</p>
<p><strong>8)</strong> จำลองการทำงานของโค้ดตัวอย่าง โดยใช้วิธี <strong>Simulator</strong> จากเมนูคำสั่ง <strong>Debug &gt; Debug Project</strong>
แต่ก่อนเริ่มต้นขั้นตอน <strong>Debug</strong> แนะนำให้เลือกตำแหน่งของบรรทัดที่จะใช้เป็น <strong>Breakpoint</strong> ในโค้ดตัวอย่าง</p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-9.png" /></p>
<p>รูป:  เมนูคำสั่งย่อยที่เกี่ยวข้องกับการทำงานของ <strong>Debugger</strong> เช่น เปิดดูค่าของตัวจับเวลาในระบบ (<strong>Stopwatch</strong>) เป็นต้น</p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-11.png" /></p>
<p>รูป: การหยุดชั่วคราวเมื่อดีบักเกอร์  (<strong>Debugger</strong>) จำลองการทำงานและทำคำสั่งมาถึงตำแหน่ง <strong>Breakpoint</strong></p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-12.png" /></p>
<p>รูป: ดูการเปลี่ยนแปลงของสถานะลอจิกที่ขา <strong>I/O Pin: PA27</strong> ในขณะที่จำลองการทำงาน</p>
<hr />
<h2 id="bare-metal-c">&#9655; <strong>การเขียนโค้ดแบบ Bare-Metal C</strong><a class="headerlink" href="#bare-metal-c" title="Permanent link">#</a></h2>
<p>ตัวอย่างโค้ดที่ 2 สาธิตการเขียนโค้ดโดยการเข้าถึงรีจิสเตอร์ แทนการเรียกใช้ฟังก์ชัน (ดังนั้นจึงเป็นการเขียนโค้ดแบบ
<strong>Bare-Metal C</strong>)</p>
<pre><code class="language-c++">#include &lt;xc.h&gt;

void sw_delay( uint32_t n ) {
    for ( uint32_t i=0; i &lt; n; i++ ) {
        asm volatile(&quot;nop&quot;);
    }
}

int main( void ) {
    SYSCTRL_REGS-&gt;SYSCTRL_OSC8M &amp;= ~SYSCTRL_OSC8M_PRESC_Msk; // 8MHz    
    PORT_REGS-&gt;GROUP[0].PORT_DIRSET = (1&lt;&lt;27); // PA27 as output pin 
    while ( 1 ) {
        PORT_REGS-&gt;GROUP[0].PORT_OUTTGL = (1&lt;&lt;27); // toggle PA27 pin
        sw_delay( 500000ul );
    }
    return 0;
}
</code></pre>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-13.png" /></p>
<p>รูป: ตัวอย่างการดีบักโค้ดและกำหนดตำแหน่ง <strong>Breakpoints</strong></p>
<p>&nbsp; </p>
<hr />
<h2 id="systick-arm-cortex-m0">&#9655; <strong>การเปิดใช้งานวงจร SysTick ของ Arm Cortex-M0+</strong><a class="headerlink" href="#systick-arm-cortex-m0" title="Permanent link">#</a></h2>
<p>ตัวอย่างโค้ดที่ 3 สาธิตการเปิดใช้งาน <strong>SysTick</strong> เพื่อใช้เป็นตัวนับของระบบด้วยความถี่คงที่ </p>
<pre><code class="language-c++">#include &lt;stddef.h&gt;             // Defines NULL
#include &lt;stdbool.h&gt;            // Defines true
#include &lt;stdlib.h&gt;             // Defines EXIT_FAILURE
#include &lt;definitions.h&gt;        // Defines SYS_Initialize    

int main( void ) {
  SYS_Initialize( NULL );
  SYSTICK_TimerStart();

  PORT_PinOutputEnable( PORT_PIN_PA27 );
  PORT_PinClear( PORT_PIN_PA27 );

  while(1) {
     PORT_PinToggle( PORT_PIN_PA27 );
     SYSTICK_DelayMs( 100 );
  }
  return EXIT_FAILURE;
}
</code></pre>
<p>หากต้องการเปิดใช้งานวงจร <strong>SysTick</strong> (ใช้ความถี่ <strong>8MHz</strong> จากวงจรภายใน) 
ในกรณีนี้ ให้เรียกใช้ <strong>MHC</strong> อีกครั้ง ตั้งค่าตามรูปตัวอย่าง และทำคำสั่ง <strong>Generate Code</strong> อีกครั้ง</p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-20.png" /></p>
<p>รูป: ตั้งค่าการใช้งานสำหรับ <strong>SysTick</strong></p>
<p>หากจะคอมไพล์โค้ดตัวอย่างและดีบักการทำงานของโค้ดโดยใช้ <strong>Simulator</strong> ให้แก้ไขโค้ดในไฟล์
<code>plib_clock.c</code> ในฟังก์ชัน <code>SYSCTRL_Initialize()</code> และ 
<code>GCLK0_Initialize()</code> ตามรูปตัวอย่าง (แก้โค้ดให้เป็น <strong>Comment</strong>)
โค้ดในส่วนดังกล่าว จะทำให้เกิดการวนลูปซ้ำแบบ <code>while</code> เพื่อคอยตรวจสอบสถานะการทำงานของฮาร์ดแวร์
แต่สำหรับการจำลองการทำงาน โค้ดดังกล่าวไม่มีความจำเป็นต้องทำ</p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-21.png" /></p>
<p>รูป: แก้ไขโค้ดบางส่วนในไฟล์ <code>plib_clock.c</code></p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-22.png" /></p>
<p>รูป: จำลองการทำงาน</p>
<p>&nbsp;</p>
<hr />
<h2 id="bin-hex">&#9655; <strong>การสร้างไฟล์ .bin จาก .hex</strong><a class="headerlink" href="#bin-hex" title="Permanent link">#</a></h2>
<p>หากต้องการทำคำสั่งต่อจากขั้นตอน <strong>Build Project</strong> ก็มีตัวอย่างดังนี้
เช่น ต้องการจะสร้างไฟล์ .bin จากไฟล์ .hex ยกเว้นกรณีที่คอมไพล์เพื่อการดีบักโค้ด ให้ใส่คำสั่ง (หนึ่งบรรทัด) ดังนี้</p>
<pre><code class="language-batch">if ${IsDebug}==&quot;false&quot; ${MP_CC_DIR}\xc32-objcopy
 -I ihex -O binary &quot;${DISTDIR}/${PROJECTNAME}.${IMAGE_TYPE}.hex&quot;
 &quot;${DISTDIR}/${PROJECTNAME}.${IMAGE_TYPE}.bin&quot;
</code></pre>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-14.png" /></p>
<p>รูป: เพิ่มคำสั่งหนึ่งบรรทัดแล้วคลิกตรง <strong>Checkbox</strong>: "<strong>Execute this line after build</strong>"</p>
<p>&nbsp;</p>
<hr />
<h2 id="bootloader">&#9655; <strong>การคอมไพล์โค้ดเพื่อใช้งานร่วมกับ Bootloader</strong><a class="headerlink" href="#bootloader" title="Permanent link">#</a></h2>
<p>หากใช้บอร์ดไมโครคอนโทรลเลอร์ <strong>ATSAMD21</strong> ที่ได้มีการติดตั้งเฟิร์มแวร์ในส่วนที่เรียกว่า <strong>Bootloader Section</strong>
เอาไว้แล้ว เช่น
<a href="https://github.com/arduino/ArduinoCore-samd/blob/master/bootloaders/zero/samd21_sam_ba.bin"><strong>Arduino Zero Bootloader</strong></a> หรือ
<a href="https://github.com/adafruit/uf2-samdx1/releases"><strong> Adafruit Zero UF2 Bootloader for SAMD21</strong></a> จำเป็นต้องเว้นช่วงแอดเดรส <code>0x0000</code> ถึง <code>0x2000</code> ในหน่วยความจำ <strong>Flash</strong> เอาไว้ ไม่ให้มีการเขียนทับ</p>
<p>ในกรณีนี้ ผู้ใช้สามารถตั้งค่าโดยใช้ <strong>MHC</strong> ได้  ซึ่งจะมีการสร้างไฟล์ <strong>Linker Script (.ld)</strong> ใหม่ และกำหนดค่าของสัญลักษณ์ดังนี้</p>
<ul>
<li><code>ROM_ORIGIN=0x2000</code></li>
<li><code>ROM_LENGTH=0x3e000</code></li>
</ul>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-15.png" /></p>
<p>รูป: ตั้งค่า <strong>Application Start Address</strong> ให้เป็น <code>0x2000</code> (แทนที่จะเริ่มต้นจาก <code>0x0000</code>)</p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-16.png" /></p>
<p>รูป: การกำหนดสัญลักษณ์ในส่วนที่เกี่ยวข้องกับ <strong>Linker Script</strong> ได้ใน <strong>Project Properties</strong></p>
<p>&nbsp;</p>
<p>ไฟล์ .bin ที่ได้จากการคอมไพล์ สามารถนำไปใช้กับโปรแกรม เช่น <code>bossac</code> ของ <strong>Arduino</strong> เพื่อใช้ในการอัปโหลดผ่านสาย
<strong>USB</strong> เมื่อทำให้ไมโครคอนโทรลเลอร์อยู่ในโหมด <strong>Bootloader</strong> เช่น กดปุ่มรีเซตสองครั้งซ้อน (<strong>Double Click</strong>)</p>
<p><img alt="" src="../samd21/images/harmony_v3_samd21_demo_1-17.png" /></p>
<p>รูป: ตัวอย่างการทำคำสั่ง <code>bossac.exe</code> ของ <strong>Arduino IDE</strong> เพื่ออัปโหลดไฟล์  <code>.bin</code> ไปยังบอร์ดไมโครคอนโทรลเลอร์</p>
<p>ตัวอย่างคำสั่งเพื่อเรียกใช้งานโปรแกรม <code>bossac.exe</code></p>
<pre><code class="language-batch">set BOSSAC=C:\Users\%USERNAME%\AppData\Local\Arduino15\packages\arduino\tools\bossac\1.7.0-arduino3\bossac.exe

set BIN_FILE=C:\Work\harmony3_projects\atsamd21\firmware\demo-1.X\dist\default\production\demo-1.X.production.bin

%BOSSAC% -i -d --port=COM33 -i -e -w -v %BIN_FILE% -R 
</code></pre>
<p><img alt="" src="../samd21/images/robotdyn_samd21_mini.jpg" /></p>
<p>รูป: บอร์ด <strong>RobotDyn SAMD21 Mini</strong> ที่ได้นำมาทดลองใช้งาน</p>
<p>&nbsp;</p>
<p>ข้อสังเกต: หากจะเลือกใช้บอร์ด <a href="https://wiki.seeedstudio.com/Seeeduino-XIAO/"><strong>Seeeduino XIAO</strong></a> แม้ว่าจะใช้ชิป <strong>ATSAMD21</strong> มี <strong>SMD LEDs</strong> ที่ขา <strong>PA17</strong>, <strong>PA18</strong>, <strong>PA19</strong> และได้ติดตั้ง <strong>Arduino-compatible Bootloader</strong> เอาไว้แล้ว แต่บอร์ดนี้ ไม่มีปุ่มรีเซต (มีแต่เพียง <strong>Reset Pad</strong> ซึ่งมีขนาดเล็ก) จึงทำให้การรีเซตบอร์ดเพื่อเข้าสู่ <strong>Bootloader Mode</strong> ทำได้ค่อนข้างยาก หรือ ไม่สะดวก</p>
<p>&nbsp;</p>
<hr />
<h2 id="_2">&#9655; <strong>แหล่งข้อมูลศึกษาเพิ่มเติม</strong><a class="headerlink" href="#_2" title="Permanent link">#</a></h2>
<ul>
<li><a href="https://microchip-mplab-harmony.github.io/bootloader_apps_uart/apps/docs/readme_configure_application_sam.html"><strong>Configuring an application to be bootloaded for CORTEX-M based MCUs</strong></a></li>
<li><a href="https://microchip-mplab-harmony.github.io/csp_apps_sam_d21_da1/"><strong>Harmony 3 peripheral library application examples for SAM D21/DA1 family</strong></a></li>
<li><a href="https://microchipdeveloper.com/harmony3:samd21-getting-started-tm-drivers-freertos"><strong>Getting Started with Harmony v3 Drivers on SAM D21 MCUs Using FreeRTOS</strong></a></li>
<li><a href="https://microchip-mplab-harmony.github.io/csp/frames.html?frmname=topic&amp;frmfile=00601.html"><strong>Microchip 32-bit Chip Support Package - SAM D20/D21 Peripheral Libraries</strong></a></li>
<li><a href="https://microchip-mplab-harmony.github.io/csp/frames.html?frmname=topic&amp;frmfile=06719.html"><strong>PORT Peripheral Library Interface</strong></a></li>
<li><a href="https://github.com/Microchip-MPLAB-Harmony/csp_apps_sam_d21_da1/"><strong>Harmony 3 Peripheral Library - Application Examples for SAM D21/DA1 Family (Code Repo)</strong></a></li>
</ul>
<hr />
<h2 id="_3">&#9655; <strong>กล่าวสรุป</strong><a class="headerlink" href="#_3" title="Permanent link">#</a></h2>
<p>บทความนี้สาธิตการติดตั้งและใช้งานซอฟต์แวร์ที่เกี่ยวข้องกับ <strong>MPLAB Harmony v3</strong> เพื่อใช้งานร่วมกับ <strong>MPLAB-X IDE</strong>
และเขียนโปรแกรมทดลองใช้งานกับบอร์ดไมโครคอนโทรลเลอร์ <strong>ATSAMD21</strong></p>
<p>&nbsp;</p>
<hr />
<p><em>This work is licensed under a</em> <strong><em>Creative Commons Attribution-ShareAlike 4.0 International License</em></strong>.</p>
<p>Created: 2022-01-30 | Last Updated: 2022-02-01</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2021-2022 IoT Engineering Education, Bangkok/Thailand</a></p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js" defer></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML" defer></script>
        <script src="../../search/main.js" defer></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
