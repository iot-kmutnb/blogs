<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        <meta name="author" content="RSP">
        <link rel="canonical" href="https://iot-kmutnb.github.io/blogs/mbedos/mbed-rp2040-part-5/">
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>ARM Mbed OS for Raspberry Pi Pico RP2040: Code Examples (Part 5) - IoT Engineering Education</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <link href="../../css/extra.css" rel="stylesheet">
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/c.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/cpp.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/arduino.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/python.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/javascript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/typescript.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/json.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/rust.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/vhdl.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/verilog.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/bash.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/text.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/plaintext.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/matlab.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/julia.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/languages/go.min.js"></script>
        <script>hljs.highlightAll();</script>
        <script async src="https://www.googletagmanager.com/gtag/js?id=G-966FQ6RN6W"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());

          gtag('config', "G-966FQ6RN6W");
        </script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">IoT Engineering Education</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item">
                                <a href="../../about/" class="nav-link">About</a>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#arm-mbed-os-for-raspberry-pi-pico-rp2040-code-examples-part-5" class="nav-link">ARM Mbed OS for Raspberry Pi Pico RP2040: Code Examples (Part 5)</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#rgb-led-active-low" class="nav-link">&#9655; การใช้งานโมดูล RGB LED แบบ Active-Low</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#ws2812b-rgb-led-neopixel" class="nav-link">&#9655; การใช้งานโมดูล WS2812B RGB LED (NeoPixel)</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#hc-sr04-ultrasonic-distance-sensor" class="nav-link">&#9655; การใช้งานโมดูล HC-SR04+ Ultrasonic Distance Sensor</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#hardware-serial" class="nav-link">&#9655; การใช้งาน Hardware Serial</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="arm-mbed-os-for-raspberry-pi-pico-rp2040-code-examples-part-5">ARM Mbed OS for Raspberry Pi Pico RP2040: Code Examples (Part 5)<a class="headerlink" href="#arm-mbed-os-for-raspberry-pi-pico-rp2040-code-examples-part-5" title="Permanent link">#</a></h1>
<p>เนื้อหาในส่วนนี้สาธิตการเขียนโค้ดโดยใช้ <strong>Mbed OS</strong> และ <strong>Arduino IDE</strong> 
สำหรับบอร์ดไมโครคอนโทรลเลอร์ที่ใช้ชิป <strong>RP2040</strong> เช่น <strong>Raspberry Pi Pico</strong> 
โดยนำเสนอเป็น <strong>ตอนที่ 5</strong> 
ต่อจาก <a href="../mbed-rp2040-part-1/"><strong>ตอนที่ 1</strong></a>
|  <a href="../mbed-rp2040-part-2/"><strong>ตอนที่ 2</strong></a>
|  <a href="../mbed-rp2040-part-3/"><strong>ตอนที่ 3</strong></a>
|  <a href="../mbed-rp2040-part-4/"><strong>ตอนที่ 4</strong></a></p>
<p><strong>Keywords</strong>: <em>Mbed OS</em>, <em>Raspberry Pi Pico</em>, 
 <em>RP2040</em>, <em>Mbed-enabled Platforms</em>, <em>RTOS Programming</em></p>
<ul>
<li><a href="#rgb-led-active-low">การใช้งานโมดูล <strong>RGB LED</strong> แบบ <strong>Active-Low</strong></a></li>
<li><a href="#ws2812b-rgb-led-neopixel">การใช้งานโมดูล <strong>WS2812B RGB LED (NeoPixel)</strong></a></li>
<li><a href="#hc-sr04-ultrasonic-distance-sensor">การใช้งานโมดูล <strong>HC-SR04+ Ultrasonic Distance Sensor</strong></a></li>
<li><a href="#hardware-serial">การใช้งาน <strong>Hardware Serial</strong></a></li>
</ul>
<hr />
<h2 id="rgb-led-active-low">&#9655; <strong>การใช้งานโมดูล RGB LED แบบ Active-Low</strong><a class="headerlink" href="#rgb-led-active-low" title="Permanent link">#</a></h2>
<p>โมดูล <strong>RGB LED</strong> สามารถให้แสงที่ประกอบด้วยสีแดง สีเขียว และสีน้ำเงิน 
ตัวอย่างของโมดูลที่ได้นำมาทดลองใช้งาน เป็นแบบ <strong>Active-Low</strong> มี 4 ขา ได้แก่ 
<strong>VCC (+3.3V)</strong>, <strong>R</strong> (<em>Red</em>), <strong>B</strong> (<em>Blue</em>), <strong>G</strong> (<em>Green</em>) ตามลำดับ 
ดังนั้นขาควบคุมสถานะมี 3 ขา ถ้ามีลอจิกเป็น 0 จะทำให้ <strong>LED</strong> ที่ตรงกับขาดังกล่าวอยู่ในสถานะ ON (สว่าง) 
แต่ถ้าเป็นลอจิก 1 จะเป็น OFF (ดับ)</p>
<p><img alt="" src="../images/rgb_led_module-1.png" />
<br>รูป: โมดูล RGB LED (Active-Low)</p>
<p>&nbsp;</p>
<p>ถ้าเขียนโค้ดโดยใช้คำสั่งของ <strong>Arduino API</strong> เพื่อทำให้ <strong>LED</strong> แต่ละสี สว่างและดับขึ้นทีละดวง ก็ใช้คำสั่ง 
<code>pinMode(...)</code> และ <code>digitalWrite(...)</code> 
และเลือกใช้ขา <strong>GP13</strong>, <strong>GP12</strong>, <strong>GP11</strong> ตามลำดับ</p>
<pre><code class="language-c++">#include &quot;mbed.h&quot;
using namespace mbed;

const int RGB_PINS[] = {13,12,11}; // (R,G,B) pins
const size_t NUM_PINS = sizeof(RGB_PINS)/sizeof(int);

void setup() {
  for ( int i=0; i &lt; NUM_PINS; i++ ) {
     pinMode( RGB_PINS[i], OUTPUT );
     digitalWrite( RGB_PINS[i], HIGH ); // initial state: OFF
  }
  SerialUSB.begin( 115200 );
  while (!SerialUSB){} // wait for Serial to open
  delay( 1000 );
}

#define ROTATE_LFET_SHIFT(x,n) (((x&lt;&lt;1)|(x&gt;&gt;(n-1))) &amp; ((1&lt;&lt;n)-1))

void loop() {
  static uint8_t state = 0b011;
  state = ROTATE_LFET_SHIFT(state,NUM_PINS);
  for ( int i=0; i &lt; NUM_PINS; i++ ) {
     digitalWrite( RGB_PINS[i], (state &gt;&gt; i) &amp; 1 );
  }
  delay( 1000 );
}
</code></pre>
<p>&nbsp;</p>
<p>แต่ถ้าใช้คำสั่งของ <strong>Mbed Drivers</strong> ก็มีคลาส <code>BusOut</code> 
ที่เหมาะสำหรับการใช้งานในกรณีนี้ (มี 3 ขา)  เป็นการใช้งานขา <strong>GPIO</strong> แบบรวมกันหรืออาร์เรย์ 
ไม่จำเป็นต้องมีหมายเลขขาต่อเนื่องกัน แต่ใช้งานในทิศทางเอาต์พุตเหมือนกัน และสามารถเขียนใหม่ได้ดังนี้</p>
<pre><code class="language-c++">#include &quot;mbed.h&quot;
using namespace mbed;

BusOut rgb(p13,p12,p11); // (R,G,B) pins

void setup() {
  rgb = 0b111; // (R,G,B) initial state: OFF
  SerialUSB.begin( 115200 );
  while (!SerialUSB){}
  delay( 1000 );
}

#define ROTATE_LFET_SHIFT(x,n) (((x&lt;&lt;1)|(x&gt;&gt;(n-1))) &amp; ((1&lt;&lt;n)-1))

void loop() {
  static uint8_t state = 0b011; 
  state = ROTATE_LFET_SHIFT(state,3); // update next state
  rgb   = state; // update output state
  delay( 1000 );
}
</code></pre>
<p><img alt="" src="../images/pico_rgb_led_module.png" />
<br>รูป: การต่อวงจรทดลองบนเบรดบอร์ดสำหรับโมดูล RGB LED</p>
<p>&nbsp;</p>
<hr />
<h2 id="ws2812b-rgb-led-neopixel">&#9655; <strong>การใช้งานโมดูล WS2812B RGB LED (NeoPixel)</strong><a class="headerlink" href="#ws2812b-rgb-led-neopixel" title="Permanent link">#</a></h2>
<p>ถัดไปเป็นการสาธิตการใช้ไลบรารีสำหรับโมดูล <strong>WS2812B</strong> หรืออีกชื่อหนึ่งคือ 
<strong>NeoPixel</strong> ของบริษัท <strong>Adafruit</strong> และทางบริษัทได้มีการพัฒนาไลบรารีให้สามารถนำไปใช้กับบอร์ดไมโครคอนโทรลเลอร์ 
เช่น <strong>AVR</strong>, <strong>nRF52</strong>, <strong>ESP8266/ESP32</strong> เป็นต้น และได้มีการเพิ่มฟังก์ชันให้สามารถใช้งานได้กับบอร์ด 
<strong>Pico RP2040</strong> โดยใช้ประโยชน์จากการทำงานของวงจรภายในที่เรียกว่า <strong>PIO</strong></p>
<p><img alt="" src="../images/ws2812_rgb_neopixel-1.png" />
<br>รูป: โมดูล WS2812 - NeoPixel (มุมมองด้านบน)</p>
<p><img alt="" src="../images/ws2812_rgb_neopixel-2.png" />
<br>รูป: โมดูล WS2812 - NeoPixel (มุมมองด้านล่าง)</p>
<p>&nbsp;</p>
<p>การติดตั้งและใช้งานไลบรารีใน <strong>Arduino IDE</strong> ก็มีขั้นตอนดังนี้ 
เปิดใช้งาน <strong>Arduino IDE</strong> และไปยังเมนู <strong>Tools &gt; Manage Libraries</strong>
ในหน้าต่าง <strong>Library Manager</strong> ให้ค้นหาไลบรารีที่มีชื่อว่า <code>adafruit_neopixel</code>
คลิกเลือกที่รายการ <strong>"Adafruit NeoPixel"</strong> แล้วกดปุ่ม <strong>Install</strong></p>
<p><img alt="" src="../images/adafruit_neopixel_lib.png" />
<br>รูป: การติดตั้งไลบรารี  <code>adafruit_neopixel</code> สำหรับ <strong>Arduino IDE</strong></p>
<p>ตัวอย่างโค้ดสาธิตการทำงานมีดังนี้ โดยเลือกใช้ขา <strong>GP15</strong> บนบอร์ด <strong>Pico</strong> 
นำไปต่อกับขา <strong>DIN</strong> ของ โมดูล <strong>NeoPixel</strong> ที่มี <strong>RGB LEDs</strong> จำนวน 8 ดวง (พิกเซล) 
ซึ่งสามารถใช้แรงดันไฟเลี้ยง +3.3V ได้</p>
<p>โค้ดตัวอย่างนี้จะทำให้แต่ละดวงเปลี่ยนเป็นสีเขียว (<strong>Green</strong>) เพิ่มขึ้นทีละดวง จนครบ 8 ดวง
แล้วดับลงตามลำดับในทิศทางตรงข้าม แล้วเกิดขึ้นซ้ำในลักษณะนี้ไปเรื่อย ๆ </p>
<pre><code class="language-c++">// https://github.com/adafruit/Adafruit_NeoPixel
// support: AVR, NF52, ESP8266/ESP32, K210, RP2040
#include &lt;Adafruit_NeoPixel.h&gt;

#define PIN         (15)
#define NUM_PIXELS   (8)
Adafruit_NeoPixel pixels( NUM_PIXELS, PIN, NEO_GRB+NEO_KHZ800 );

void setup() {
  SerialUSB.begin(115200);
  while(!SerialUSB){}
  pixels.begin(); // initialize NeoPixel
}

const uint32_t GREEN_COLOR = pixels.Color(0, 150, 0);

void loop() {
  pixels.clear();
  for( int i=0; i &lt; 2*NUM_PIXELS; i++ ) { // for each pixel...
    if (i &lt; NUM_PIXELS) {
      pixels.setPixelColor( i, GREEN_COLOR );
    } else {
      pixels.setPixelColor( 2*NUM_PIXELS-i-1, 0 /*OFF*/ );
    }
    pixels.show();   // Send the updated pixel colors to the hardware.
    delay( 150 ); // Pause before next pass through loop
  }
}
</code></pre>
<p><img alt="" src="../images/pico_ws2812_rgb_led_bar.png" />
<br>รูป: การต่อวงจรทดลองบนเบรดบอร์ดเพื่อใช้งานโมดูล NeoPixel RGB LED Bar</p>
<p>&nbsp;</p>
<hr />
<h2 id="hc-sr04-ultrasonic-distance-sensor">&#9655; <strong>การใช้งานโมดูล HC-SR04+ Ultrasonic Distance Sensor</strong><a class="headerlink" href="#hc-sr04-ultrasonic-distance-sensor" title="Permanent link">#</a></h2>
<p>โมดูล <strong>HC-SR04+</strong> เป็นตัวอย่างของเซ็นเซอร์ที่ใช้คลื่นเสียงที่มีความถี่สูง (เช่น  <strong>40kHz</strong> หรือมากกว่า) 
ในการตรวจจับวัตถุกีดขวาง เมื่อส่งสัญญาณเสียงจากตัวส่งแล้วไปกระทบกับวัตถุ จะได้เสียงสะท้อนกลับมายังตัวรับสัญญาณ 
ถ้าจับเวลาตั้งแต่ส่งคลื่นเสียงออกไปและได้รับคลื่นสะท้อนกลับมา ก็สามารถคำนวณระยะห่างจากวัตถุดังกล่าวได้</p>
<p><img alt="" src="../images/pico_hc-sr04.png" />
<br>รูป: โมดูล HC-SR04+ Ultrasonic Distance Sensor</p>
<p>&nbsp;</p>
<p>โมดูล <strong>HC-SR04+</strong> สามารถใช้แรงดันไฟเลี้ยง <strong>+3.3V</strong> มีขาอินพุต <strong>TRIG</strong> 
ไว้สร้างสัญญาณพัลส์เพื่อเริ่มต้นการวัดระยะห่าง และมีขาเอาต์พุต <strong>ECHO</strong> เป็นสัญญาณพัลส์แบบ High </p>
<p>ความกว้างของพัลส์ (<strong>Pulse Width</strong>) ที่วัดได้ หรือค่า <script type="math/tex">t_{pulse}</script> มีความสัมพันธ์แบบเชิงเส้นกับระยะห่างจากวัตถุ (<strong>Distance</strong>) 
ตามสูตรต่อไปนี้ (ถ้ากำหนดให้ความเร็วของคลื่นเสียงในอากาศเท่ากับ <strong>343 m/s</strong>
โดยประมาณ)</p>
<p>
<script type="math/tex; mode=display">Distance [cm] = 343 [m/s] \cdot 10^2 
\cdot \frac{t_{pulse}}{2} [usec]</script>
</p>
<p>&nbsp;</p>
<p>ตัวอย่างการเขียนโค้ดโดยใช้คำสั่งของ <strong>Arduino</strong> มีดังนี้</p>
<pre><code class="language-c++">// speed of sound in the air at sea level
#define SOUND_SPEED  (340)  // ~340 m/s

#define TRIG_PIN  (p15)
#define ECHO_PIN  (p14)

void setup() {
  SerialUSB.begin( 115200 );
  while(!SerialUSB){}
  pinMode( ECHO_PIN, INPUT_PULLUP );
  pinMode( TRIG_PIN, OUTPUT );
  digitalWrite( TRIG_PIN, LOW );
}

bool measure( float *distance ) {
  uint32_t countdown;
  // generate a high pulse on TRIG pin
  digitalWrite( TRIG_PIN, HIGH );
  delayMicroseconds(20);
  digitalWrite( TRIG_PIN, LOW );

  countdown = 100;
  // wait until the ECHO pin goes high
  while ( digitalRead(ECHO_PIN) == LOW ){
    if ( countdown == 0 ) return false;
    countdown--;
    delayMicroseconds(1);
  }
  uint32_t t_start = micros();

  countdown = 20000;
  // wait until the ECHO pin goes low
  while (  digitalRead(ECHO_PIN) == HIGH ) {
    if ( countdown == 0 ) return false;
    countdown--;
    delayMicroseconds(1);
  }
  uint32_t t_end = micros();

  // calculate the pulse width
  uint32_t t_pulse = t_end - t_start;
  // calculate the distance (in cm.)
  *distance = SOUND_SPEED*t_pulse/2.0/10000;
  return true;
}

char sbuf[32];

void loop() {
  float distance;
  if ( measure( &amp;distance ) ) {
     sprintf( sbuf, &quot;Distance: %.1f cm&quot;, distance );
     SerialUSB.println( sbuf );
  } else {
     SerialUSB.println( &quot;Timeout&quot; );
  }
  delay( 500 );
}
</code></pre>
<p>&nbsp;</p>
<p>คำสั่ง <code>pulseIn()</code> ของ <strong>Arduino Core for Mbed</strong> เป็นฟังก์ชันที่ถูกสร้างไว้ในไฟล์
<a href="https://github.com/arduino/ArduinoCore-mbed/blob/master/cores/arduino/wiring_pulse.cpp"><code>cores/arduino/wiring_pulse.cpp.c</code></a></p>
<p><img alt="" src="../images/arduino_mbed_rp2040_pulsein.png" />
<br>รูป: โค้ดในส่วนที่เกี่ยวข้องกับการทำงานของฟังก์ชัน <code>pulseIn()</code></p>
<p>ถ้าจะเปลี่ยนมาใช้คำสั่ง <code>pulseIn()</code> ก็มีตัวอย่างดังนี้</p>
<pre><code class="language-c++">// speed of sound in the air at sea level
#define SOUND_SPEED  (340)  // ~340 m/s

#define TRIG_PIN  (p15)
#define ECHO_PIN  (p14)

void setup() {
  SerialUSB.begin( 115200 );
  while(!SerialUSB){}
  pinMode( ECHO_PIN, INPUT_PULLUP );
  pinMode( TRIG_PIN, OUTPUT );
  digitalWrite( TRIG_PIN, LOW );
}

bool measure( float *distance ) {
  uint32_t t_pulse;

  // generate a high pulse on TRIG pin
  digitalWrite( TRIG_PIN, HIGH );
  delayMicroseconds(20);
  digitalWrite( TRIG_PIN, LOW );

  // measure the HIGH pulse width of the echo signal
  t_pulse = pulseIn( ECHO_PIN, HIGH );
  // calculate the distance (in cm.)
  *distance = SOUND_SPEED*t_pulse/2.0/10000;
  return (t_pulse &gt; 0);
}

char sbuf[32];

void loop() {
  float distance;
  if ( measure( &amp;distance ) ) {
     sprintf( sbuf, &quot;Distance: %.1f cm&quot;, distance );
     SerialUSB.println( sbuf );
  } else {
     SerialUSB.println( &quot;Timeout&quot; );
  }
  delay( 500 );
}
</code></pre>
<p>&nbsp;</p>
<p>ตัวอย่างการเขียนโค้ดโดยใช้ <strong>Mbed Drivers</strong> มีดังนี้</p>
<pre><code class="language-c++">#include &quot;mbed.h&quot;
using namespace mbed;

// speed of sound in the air at sea level
#define SOUND_SPEED  (340)  // ~340 m/s

DigitalOut trig(p15);
DigitalIn  echo(p14);

void setup() {
  SerialUSB.begin( 115200 );
  while(!SerialUSB){}
  echo.mode( PullUp );
  trig = 0;
}

bool measure( float *distance ) {
  uint32_t countdown;
  // generate a high pulse on TRIG pin
  trig = 1;
  wait_us(20);
  trig = 0;

  countdown = 100;
  // wait until the ECHO pin goes high
  while ( echo == 0 ){
    if ( countdown == 0 ) return false;
    countdown--;
    wait_us(1);
  }
  uint32_t t_start = micros();

  countdown = 20000;
  // wait until the ECHO pin goes low
  while ( echo == 1 ) {
    if ( countdown == 0 ) return false;
    countdown--;
    wait_us(1);
  }
  uint32_t t_end = micros();

  // calculate the pulse width
  uint32_t t_pulse = t_end - t_start;
  // calculate the distance (in cm.)
  *distance = SOUND_SPEED*t_pulse/2.0/10000;
  return true;
}

char sbuf[32];

void loop() {
  float distance;
  if ( measure( &amp;distance ) ) {
     sprintf( sbuf, &quot;Distance: %.1f cm&quot;, distance );
     SerialUSB.println( sbuf );
  } else {
     SerialUSB.println( &quot;Timeout&quot; );
  }
  delay( 500 );
}
</code></pre>
<p>รูปแบบการเชื่อมต่อระหว่างโมดูล <strong>HC-SR04+</strong> กับบอร์ด <strong>Pico</strong> มีดังนี้</p>
<pre><code class="language-text">Pico       HC-SR04+
GND   ---- GND
GP14  &lt;--- Echo
GP15  ---&gt; Trig
3.3V  ---- VCC
</code></pre>
<p>&nbsp;</p>
<p><img alt="" src="../images/hc-sr04_ultrasonic_module.png" />
<br>รูป: การต่อวงจรใช้งานโมดูล HC-SR04+ ร่วมกับบอร์ด Pico</p>
<p>&nbsp;</p>
<p><img alt="" src="../images/wokwi_rp2040_arduino_hcsr04.png" />
<br>รูป: การจำลองการทำงานของโค้ดตัวอย่างโดยใช้ <strong>Wokwi Simulator</strong></p>
<p>&nbsp;</p>
<hr />
<h2 id="hardware-serial">&#9655; <strong>การใช้งาน Hardware Serial</strong><a class="headerlink" href="#hardware-serial" title="Permanent link">#</a></h2>
<p>วงจรภายในไมโครคอนโทรลเลอร์ที่เรียกว่า <strong>UART</strong>
(<em>Universally Asynchronous Receiver / Transmitter</em>)
ใช้วิธีรับส่งข้อมูลทีละบิตแบบสองทิศทางและไม่มีการสร้างสัญญาณ <strong>Clock</strong> เป็นสัญญาณควบคุม
และเลือกรูปแบบการใช้งานขา <strong>I/O</strong> ที่เกี่ยวข้องให้เป็นขา <strong>TX/RX</strong> (<em>Transmit Data / Receive Data</em>)</p>
<p>การใช้งาน <strong>Serial</strong> ของบอร์ด <strong>Pico</strong> โดยใช้ <strong>Arduino API</strong> มีตัวเลือกดังนี้</p>
<ul>
<li><code>Serial</code> หรือ <code>SerialUSB</code> ใช้วิธีการสื่อสารผ่าน <strong>Native (built-in) USB</strong> โดยตรง</li>
<li><code>Serial1</code> เป็นการใช้งานวงจร <strong>UART0</strong> ที่มีอยู่ภายในชิป <strong>RP2040</strong> และใช้ขา <strong>GP0 / GP1</strong>
สำหรับขา <strong>TX / RX</strong> ของ <strong>UART0</strong> ตามลำดับ</li>
</ul>
<p>ตัวอย่างแรกสาธิตการเขียนโค้ดเพื่อรอรับข้อมูลจากคอมพิวเตอร์ของผู้ใช้ผ่านทาง <code>SerialUSB</code> 
เมื่อได้รับข้อมูลไบต์หนึ่งไบต์ ก็ส่งออกทาง <code>Serial1</code> แต่ถ้ามีข้อมูลรับเข้ามาทาง <code>Serial1</code> 
ให้รับข้อมูลแล้วส่งต่อออกทาง <code>SerialUSB</code> ในทางกลับกัน </p>
<p>ดังนั้น <strong>Pico</strong> ในตัวอย่างนี้ จึงทำงานเป็นตัวส่งต่อข้อมูลระหว่าง <code>SerialUSB</code> กับ <code>Serial1</code> ในทั้งสองทิศทาง
ในการทดลองกับฮาร์ดแวร์จริง ให้เชื่อมต่อขา <strong>GP0</strong> ไปยัง <strong>GP1</strong> (ขา <strong>TX</strong> เชื่อมต่อไปยัง <strong>RX</strong>) 
ด้วยสายไฟหนึ่งเส้น เพื่อใช้งานในลักษณะ <strong>Serial Loopback</strong></p>
<pre><code class="language-c++">void setup() {
  SerialUSB.begin( 115200 );
  while (!SerialUSB){} // wait for SerialUSB to open
  Serial1.begin( 115200 );
}

char data;

void loop() {
  // read from SerialUSB, write to Serial1
  while ( SerialUSB.available() &gt; 0 ) {
     data = SerialUSB.read();
     Serial1.write( data );
  }
  // read from Serial1, write to SerialUSB
  while ( Serial1.available() &gt; 0 ) {
     data = Serial1.read();
     SerialUSB.write( data );
  }
}
</code></pre>
<p>หรือถ้าจะเขียนโค้ดโดยการแบ่งการทำงานเป็น 2 ส่วนย่อยที่ทำงานได้พร้อม ๆ กัน ให้รับและส่งข้อมูลในแต่ละทิศทาง 
โดยใช้ <strong>Mbed Threads</strong> ก็มีตัวอย่างดังนี้</p>
<pre><code class="language-c++">#include &quot;mbed.h&quot;
using namespace mbed;
using namespace rtos;

Thread t1, t2; // create two threads

void from_serialusb_to_serial1() { // for the first thread
  while (1) {
    // read from SerialUSB and write to Serial1
    while ( SerialUSB.available() &gt; 0 ) {
       Serial1.write( SerialUSB.read() );
    }
    yield(); // pass control to other threads
  }
}

void from_serial1_to_serialusb() { // for the second thread
  while (1) {
    // read from Serial1 and write to SerialUSB
    while ( Serial1.available() &gt; 0 ) {
      SerialUSB.write( Serial1.read() );
    }
    yield(); // pass control to other threads
  }
}

void setup() {
  SerialUSB.begin( 115200 );
  while (!SerialUSB){} // wait for SerialUSB to open
  Serial1.begin( 115200 );
  // start both threads to handle serial streams
  t1.start( &amp;from_serialusb_to_serial1 );
  t2.start( &amp;from_serial1_to_serialusb );
}

void loop() {}
</code></pre>
<p>วงจร <strong>UART</strong> (หรืออาจเรียกว่า <strong>Serial</strong>)
ของไมโครคอนโทรลเลอร์ ไม่สามารถสื่อสารข้อมูลได้โดยตรงกับคอมพิวเตอร์ของผู้ใช้
ดังนั้นจึงต้องใช้โมดูล <strong>USB-to-Serial</strong> ในการเชื่อมต่อ
ถ้าจะส่งข้อมูลไปยังคอมพิวเตอร์โดยไม่ใช้วงจร <strong>USB</strong> ของ <strong>Pico</strong>
ตัวอย่างถัดไปเป็นการใช้โมดูล <strong>USB-to-Serial</strong> เพื่อส่งข้อมูลจาก ** Pico** ไปยังคอมพิวเตอร์ของผู้ใช้</p>
<pre><code class="language-c++">void setup() {
  // use Serial1 (UART0)
  // Arduino default pins: Tx/Rx = GP0/GP1
  Serial1.begin( 115200 );
}

char sbuf[32];

void loop() {
  static uint32_t cnt = 0;
  sprintf( sbuf, &quot;Count: %lu&quot;, cnt++ );
  Serial1.println( sbuf );
  delay( 500 );
}
</code></pre>
<p>หรืออาจเขียนโค้ดใหม่ที่ให้ผลเหมือนกัน โดยใช้คำสั่ง <code>printf()</code> ของ 
<strong>Mbed OS</strong> ซึ่งจะตรงกับ <strong>UART0</strong> (ใช้ขา <strong>GP0 / GP1</strong>) ของบอร์ด <strong>Pico</strong></p>
<pre><code class="language-c++">void setup() {
  // empty
}

char sbuf[32];

void loop() {
  static uint32_t cnt = 0;
  sprintf( sbuf, &quot;Count: %lu\n&quot;, cnt++ );
  std::printf( sbuf ); // send string to serial
  delay( 500 );
}
</code></pre>
<p>แต่ถ้าจะเปลี่ยนมาใช้ <strong>Mbed OS Drivers</strong> แทน <code>Serial1</code> 
ก็มีคลาสให้ใช้งาน เช่น <a href="https://os.mbed.com/docs/mbed-os/latest/apis/unbufferedserial.html"><code>UnbufferedSerial</code></a> ตามตัวอย่างโค้ดต่อไปนี้</p>
<pre><code class="language-c++">#include &quot;mbed.h&quot;
using namespace mbed;

#define TX_PIN  (p0)
#define RX_PIN  (p1)

UnbufferedSerial serial( TX_PIN, RX_PIN, 115200 );

void setup() {
  // 8-bit data, no parity bit, 1 stop bit
  serial.format( 8, SerialBase::None, 1 );
}

char sbuf[32];

void loop() {
  static uint32_t cnt = 0;
  while (!serial.writable()) {}
  sprintf( sbuf, &quot;Count: %lu\n&quot;, cnt++ );
  serial.write( sbuf, strlen(sbuf) ); // send string
  serial.sync(); // flush output
  delay( 500 );
}
</code></pre>
<p>การต่อวงจรใช้งานโมดูล <strong>USB-to-Serial</strong> (เช่น โมดูลที่ใช้ไอซี <strong>CP2102</strong> หรือ <strong>CP2104</strong>)
จะใช้เพียง 3 ขา คือ <strong>GND</strong>, <strong>TXD</strong>, <strong>RXD</strong> โดยใช้แรงดันไฟเลี้ยง <strong>+5V</strong>
จากพอร์ต <strong>USB</strong> ของคอมพิวเตอร์
(แต่ขา <strong>TXD / RXD</strong> ทำงานที่ระดับแรงดันสำหรับลอจิกที่ <strong>+3.3V</strong>) </p>
<p>รูปแบบการเชื่อมต่อมีดังนี้</p>
<pre><code class="language-text">Pico        USB-to-Serial module
GND    ---- GND
GP0/TX ---&gt; TXD  
GP1/RX &lt;--- RXD 
</code></pre>
<p><img alt="" src="../images/pico_cp2104_usb2serial.png" />
<br>รูป: การต่อวงจรทดลองใช้งานร่วมกับโมดูล CP2104 USB-to-Serial</p>
<p>&nbsp;</p>
<hr />
<p><em>This work is licensed under a</em> <strong><em>Creative Commons Attribution-ShareAlike 4.0 International License.</em></strong></p>
<p>Created: 2021-12-16 | Last Updated: 2022-03-03</p></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
                <p>Copyright &copy; 2021-2026 IoT Engineering Education, Bangkok/Thailand</a></p>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.4/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
